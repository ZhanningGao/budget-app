<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è£…ä¿®é¢„ç®—è¡¨ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Chart.js for pie charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js datalabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
                box-shadow: none;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 20px;
                margin-bottom: 5px;
            }
            .header p {
                font-size: 13px;
            }
        }

        .toolbar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-info {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
        }

        @media (max-width: 768px) {
            .toolbar {
                padding: 12px 10px;
                gap: 10px;
            }
            .toolbar-row {
                width: 100%;
            }
            .toolbar-row .btn {
                flex: 1;
                min-width: 0;
            }
            .toolbar-info {
                width: 100%;
                border-top: 1px solid #dee2e6;
                margin-top: 5px;
                padding-top: 10px;
            }
        }

        @media (min-width: 769px) {
            .toolbar-row {
                flex: 1;
            }
            .toolbar-info {
                margin-left: auto;
            }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 12px 16px;
                font-size: 14px;
                width: 100%;
                min-height: 44px; /* ç§»åŠ¨ç«¯æœ€å°è§¦æ‘¸åŒºåŸŸ */
                border-radius: 8px;
            }
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
        }

        .content {
            padding: 30px;
        }

        .category-section {
            margin-bottom: 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .category-section {
                margin-bottom: 20px;
                border-radius: 6px;
            }
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-toggle {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .category-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 10000px; /* è¶³å¤Ÿå¤§çš„å€¼ */
        }

        .category-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .table-wrapper {
                margin: 0 -10px;
                padding: 0 10px;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px; /* ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ */
        }

        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
            th {
                font-size: 11px;
            }
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
            font-size: 13px;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background: #e9ecef;
        }

        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            color: #667eea;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr.selected {
            background: #e7f3ff;
        }

        /* æ¡Œé¢ç«¯æ˜¾ç¤ºæ“ä½œåˆ— */
        .desktop-only {
            display: table-cell;
        }

        /* ç§»åŠ¨ç«¯ï¼šæ•´è¡Œå¯ç‚¹å‡»ï¼Œæ›´ç´§å‡‘ */
        @media (max-width: 768px) {
            /* éšè—æ“ä½œåˆ—å’Œå¤é€‰æ¡†åˆ— */
            .desktop-only,
            .checkbox-cell {
                display: none !important;
            }
            
            /* æ•´è¡Œå¯ç‚¹å‡» */
            tbody tr[data-item-id] {
                cursor: pointer;
            }
            
            /* å‡å°è¡Œé—´è·ï¼Œæ›´ç´§å‡‘ */
            td {
                padding: 6px 4px;
                font-size: 11px;
                border-bottom: 1px solid #e9ecef;
            }
            
            th {
                padding: 6px 4px;
                font-size: 10px;
            }
            
            /* å‡å°è¡¨æ ¼æ•´ä½“é—´è· */
            .category-section {
                margin-bottom: 12px;
            }
            
            /* æ›´ç´§å‡‘çš„å­—ä½“å’Œé—´è· */
            .content {
                padding: 10px 5px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .category-header {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            /* é¡¹ç›®åç§°åŠ ç²—ä½†å­—ä½“ç¨å° */
            td strong {
                font-size: 12px;
            }
            
            /* ç§»åŠ¨ç«¯éšè—åˆ é™¤æŒ‰é’®ï¼ˆå› ä¸ºæ²¡æœ‰å¤é€‰æ¡†äº†ï¼‰ */
            #deleteBtn {
                display: none !important;
            }
        }

        .checkbox-cell {
            text-align: center;
            width: 50px;
        }

        .action-cell {
            text-align: center;
            width: 100px;
        }

        .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        /* ç§»åŠ¨ç«¯è¯¦æƒ…å¼¹çª—æ ·å¼ */
        .mobile-detail-modal .modal-content {
            max-width: 95%;
            width: 95%;
            max-height: 90vh;
            padding: 0;
            border-radius: 12px;
        }
        
        /* å•å­—æ®µç¼–è¾‘å¼¹çª—æ ·å¼ */
        #fieldEditModal .modal-content {
            max-width: 90%;
            width: 90%;
        }
        
        #fieldEditModal .mobile-detail-body {
            padding: 20px;
        }
        
        #fieldEditModal input,
        #fieldEditModal textarea {
            font-size: 16px; /* iOS Safari éœ€è¦è‡³å°‘ 16px æ‰èƒ½é¿å…è‡ªåŠ¨ç¼©æ”¾ */
        }

        .mobile-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-detail-header h2 {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .mobile-detail-body {
            padding: 12px 16px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            font-size: 13px;
        }

        .mobile-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-detail-item:active {
            background-color: #f8f9fa;
        }
        
        .mobile-detail-item:not([data-field]) {
            cursor: default;
        }

        .mobile-detail-item:last-child {
            border-bottom: none;
        }

        .mobile-detail-label {
            color: #6c757d;
            font-size: 12px;
            min-width: 80px;
        }

        .mobile-detail-value {
            color: #212529;
            font-size: 13px;
            font-weight: 500;
            text-align: right;
            flex: 1;
        }
        
        .mobile-detail-item[data-field] .mobile-detail-value::after {
            content: ' â€º';
            color: #999;
            margin-left: 8px;
        }

        .mobile-detail-actions {
            display: flex;
            padding: 12px 16px;
            border-top: 1px solid #e9ecef;
            gap: 8px;
        }

        .mobile-detail-actions .btn {
            min-height: 40px;
            font-size: 14px;
        }

        /* ç§»åŠ¨ç«¯éšè—è¯¦æƒ…å¼¹çª—ï¼Œæ¡Œé¢ç«¯æ˜¾ç¤º */
        @media (min-width: 769px) {
            .mobile-detail-modal {
                display: none !important;
            }
        }

        /* é¥¼å›¾æ ·å¼ */
        #budgetChart, #actualChart {
            max-height: 300px;
        }

        #budgetLegend, #actualLegend, #categoryBudgetLegend, #categoryActualLegend {
            font-size: 12px;
        }

        #categoryChartModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        #categoryBudgetChart, #categoryActualChart {
            max-height: 250px;
        }

        @media (max-width: 768px) {
            #categoryChartModal .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 10px;
            }
            
            #categoryBudgetChart, #categoryActualChart {
                max-height: 200px;
            }
            
            #categoryBudgetLegend, #categoryActualLegend {
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            #budgetChart, #actualChart {
                max-height: 200px;
            }
            
            #budgetLegend, #actualLegend {
                font-size: 11px;
            }
            
            /* ç§»åŠ¨ç«¯å›¾ä¾‹å’Œé¥¼å›¾å‚ç›´æ’åˆ— */
            #budgetChart, #actualChart {
                max-width: 100%;
            }
        }

        /* ç§»åŠ¨ç«¯ç¼–è¾‘å¼¹çª—æ ·å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            #itemModal .modal-content {
                max-height: 95vh;
                padding: 15px;
            }
            
            #itemModal .modal-header h2 {
                font-size: 16px;
            }
            
            #itemModal .form-group label {
                font-size: 13px;
            }
            
            #itemModal input,
            #itemModal select,
            #itemModal textarea {
                font-size: 14px;
                padding: 8px;
            }
            
            #itemModal .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            #itemModal .modal-actions .btn {
                width: 100%;
                min-height: 44px;
            }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 100%;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                padding: 20px 15px;
            }
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-header h2 {
            color: #495057;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .modal-actions {
                flex-direction: column-reverse;
                gap: 10px;
                margin-top: 20px;
            }
            .modal-actions .btn {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .status-message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .summary {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            font-weight: 500;
        }

        .ai-input-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
        }

        .ai-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ai-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .ai-input-textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s;
        }

        .ai-input-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ai-input-actions {
            display: flex;
            gap: 10px;
        }

        .ai-preview {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .ai-preview-item {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ai-preview-item:last-child {
            border-bottom: none;
        }

        .ai-preview-label {
            font-weight: 600;
            color: #495057;
        }

        .ai-preview-value {
            color: #212529;
        }

        .ai-preview-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .config-modal.active {
            display: flex;
        }

        .config-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .config-help {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .config-help h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .config-help ol {
            margin: 0;
            padding-left: 20px;
        }

        .config-help li {
            margin: 5px 0;
        }

        /* ========== ç§»åŠ¨ç«¯ä¼˜åŒ– (H5é£æ ¼) ========== */
        @media (max-width: 768px) {
            /* å…¨å±€ä¼˜åŒ– */
            * {
                -webkit-tap-highlight-color: transparent;
            }

            /* æŒ‰é’®ç»„ä¼˜åŒ– */
            .toolbar-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                width: 100%;
            }

            .toolbar-row .btn {
                width: 100%;
                margin: 0;
            }

            /* å¿«é€Ÿæ·»åŠ åŒºåŸŸ */
            .ai-input-container {
                flex-direction: column;
                align-items: stretch;
            }

            .ai-input-textarea {
                width: 100%;
                margin-bottom: 10px;
            }

            .ai-input-actions {
                width: 100%;
                flex-direction: column;
            }

            .ai-input-actions .btn {
                width: 100%;
            }

            /* è¡¨æ ¼ä¼˜åŒ– - å¡ç‰‡å¼æ˜¾ç¤º */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 700px; /* å‡å°æœ€å°å®½åº¦ï¼Œæ›´ç´§å‡‘ï¼ˆç§»é™¤äº†å¤é€‰æ¡†åˆ—ï¼‰ */
            }

            /* åˆ†ç±»æ ‡é¢˜ */
            .category-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .category-actions {
                width: 100%;
                justify-content: space-between;
            }

            /* æ€»è®¡æ˜¾ç¤ºä¼˜åŒ– */
            .summary {
                flex-direction: column;
                gap: 10px;
                text-align: center;
                font-size: 14px;
            }

            /* æ¨¡æ€æ¡†æ ‡é¢˜ */
            .modal-header h2 {
                font-size: 20px;
            }

            /* è¡¨å•è¾“å…¥ä¼˜åŒ– */
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                padding: 12px;
            }

            /* çŠ¶æ€æ¶ˆæ¯ */
            .status-message {
                margin: 10px;
                padding: 12px 15px;
                font-size: 14px;
            }

            /* ç©ºçŠ¶æ€ */
            .empty-state {
                padding: 40px 20px;
                font-size: 14px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .toolbar-row {
                grid-template-columns: 1fr;
            }

            .category-header {
                font-size: 14px;
                padding: 10px 12px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 6px 4px;
            }
        }

        /* æ¡Œé¢ç«¯ä¿æŒåŸæ · */
        @media (min-width: 769px) {
            .toolbar-row {
                display: flex;
                gap: 10px;
            }

            .toolbar-info {
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <!-- å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
    <div id="passwordModal" class="modal" style="display: flex; z-index: 3000;">
        <div class="modal-content" style="max-width: 400px; width: 90%;">
            <div class="modal-header">
                <h2>ğŸ”’ è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            </div>
            <form id="passwordForm" onsubmit="return verifyPassword(event)">
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " required autofocus>
                    <div id="passwordError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">éªŒè¯</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>ğŸ  è£…ä¿®é¢„ç®—è¡¨ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ä¾¿æ·ç®¡ç†æ‚¨çš„è£…ä¿®é¡¹ç›®</p>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-success" onclick="showAddModal()">â• æ·»åŠ é¡¹ç›®</button>
            <button class="btn btn-success" onclick="showAddCategoryModal()" style="background: #17a2b8;">ğŸ“ æ–°å¢åˆ†ç±»</button>
            <button class="btn btn-danger" onclick="deleteSelected()" id="deleteBtn" disabled>ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            <button class="btn btn-secondary" onclick="showImportModal()" style="background: #ffc107; color: #000;">ğŸ“¤ å¯¼å…¥Excel</button>
            <button class="btn btn-secondary" onclick="exportFile()">ğŸ“¥ å¯¼å‡ºExcel</button>
            <button class="btn btn-secondary" onclick="exportPDF()" style="background: #dc3545;">ğŸ“„ å¯¼å‡ºPDF</button>
            <button class="btn btn-secondary" onclick="showBackupModal()" style="background: #28a745;">ğŸ’¾ å¤‡ä»½/æ¢å¤</button>
            <div style="flex: 1;"></div>
            <span id="itemCount" style="color: #6c757d; font-weight: 500;">å…± 0 é¡¹</span>
        </div>

        <!-- å¿«é€Ÿè¾“å…¥åŒºåŸŸ -->
        <div class="ai-input-section">
            <div class="ai-input-header">
                <div>
                    <span style="font-weight: 600; color: #667eea;">âš¡ å¿«é€Ÿæ·»åŠ </span>
                    <span style="font-size: 12px; margin-left: 10px; color: #6c757d;">è¾“å…¥æ–‡æœ¬è‡ªåŠ¨è§£æå¹¶æ·»åŠ é¡¹ç›®</span>
                </div>
            </div>
            <div class="ai-input-container">
                <textarea 
                    id="aiInput" 
                    class="ai-input-textarea" 
                    placeholder="ä¾‹å¦‚ï¼šå…¨å±‹åŸºç¡€è£…ä¿®ï¼Œ1å¥—ï¼Œé¢„ç®—24500å…ƒï¼Œå®é™…èŠ±è´¹24500å…ƒï¼Œå¤‡æ³¨ï¼šé»„æ±Ÿå·¥é•¿ï¼Œèµµå¨…å¨œä»‹ç»&#10;æ”¯æŒæ‰¹é‡æ·»åŠ ï¼Œæ¯è¡Œä¸€ä¸ªé¡¹ç›®ï¼Œç”¨æ¢è¡Œåˆ†éš”"
                    rows="4"></textarea>
                <div class="ai-input-actions">
                    <button class="btn btn-primary" onclick="parseAndPreview()">ğŸ” è§£æé¢„è§ˆ</button>
                    <button class="btn btn-success" onclick="parseAndAdd()">âœ¨ ç›´æ¥æ·»åŠ </button>
                </div>
            </div>
            <div id="aiPreview" class="ai-preview" style="display: none;"></div>
        </div>

        <div class="content">
            <div id="statusMessage" class="status-message"></div>
            <div id="loading" class="loading" style="display: none;">
                <p>åŠ è½½ä¸­...</p>
            </div>
            <div id="contentContainer"></div>
        </div>
    </div>

    <!-- å¯¼å…¥Excelæ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>å¯¼å…¥Excelæ–‡ä»¶</h2>
            </div>
            <div class="config-help" style="margin-bottom: 20px;">
                <h4>å¯¼å…¥è¦æ±‚ï¼š</h4>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>æ–‡ä»¶æ ¼å¼ï¼š.xlsx æˆ– .xls</li>
                    <li>å¿…é¡»åŒ…å«åˆ†ç±»è¡Œï¼ˆä»¥"ä¸€ã€"ã€"äºŒã€"ç­‰å¼€å¤´ï¼‰</li>
                    <li>å¿…é¡»åŒ…å«è¡¨å¤´è¡Œï¼ˆåŒ…å«"åºå·"å’Œ"é¡¹ç›®"åˆ—ï¼‰</li>
                    <li>âš ï¸ å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®</li>
                    <li>å»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</li>
                </ul>
            </div>
            <form id="importForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>é€‰æ‹©Excelæ–‡ä»¶ *</label>
                    <input type="file" id="importFileInput" name="file" accept=".xlsx,.xls" required>
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼ï¼Œæœ€å¤§ 16MB
                    </small>
                </div>
                <div id="importValidation" style="display: none; margin: 15px 0;"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="validateImportFile()">ğŸ” éªŒè¯æ ¼å¼</button>
                    <button type="submit" class="btn btn-success">âœ… ç¡®è®¤å¯¼å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ–°å¢åˆ†ç±»æ¨¡æ€æ¡† -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢åˆ†ç±»</h2>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label>åˆ†ç±»åç§° *</label>
                    <input type="text" id="categoryNameInput" placeholder="ä¾‹å¦‚ï¼šå…¨å±‹åŸºè£…ã€å…¨å±‹æŸœå­" required>
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        è¾“å…¥åˆ†ç±»åç§°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ã€è¡¨å¤´å’Œåˆè®¡è¡Œ
                    </small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºåˆ†ç±»</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ†ç±»é¡¹ç›®é¥¼å›¾å¼¹çª— -->
    <div id="categoryChartModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="categoryChartTitle">åˆ†ç±»é¡¹ç›®å æ¯”</h2>
                <button type="button" class="close-btn" onclick="closeCategoryChartModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;">
                    <div style="flex: 1; min-width: 300px; max-width: 400px;">
                        <div style="text-align: center; font-weight: 600; margin-bottom: 15px; font-size: 16px;">é¢„ç®—è´¹ç”¨é¡¹ç›®å æ¯”</div>
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1; max-width: 200px;">
                                <canvas id="categoryBudgetChart"></canvas>
                            </div>
                            <div id="categoryBudgetLegend" style="flex: 1; display: flex; flex-direction: column; justify-content: center;"></div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 300px; max-width: 400px;">
                        <div style="text-align: center; font-weight: 600; margin-bottom: 15px; font-size: 16px;">æœ€ç»ˆèŠ±è´¹é¡¹ç›®å æ¯”</div>
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1; max-width: 200px;">
                                <canvas id="categoryActualChart"></canvas>
                            </div>
                            <div id="categoryActualLegend" style="flex: 1; display: flex; flex-direction: column; justify-content: center;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="padding: 15px; border-top: 1px solid #e9ecef;">
                <button type="button" class="btn btn-secondary" onclick="closeCategoryChartModal()" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¤‡ä»½/æ¢å¤æ¨¡æ€æ¡† -->
    <div id="backupModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤</h2>
                <button type="button" class="close-btn" onclick="closeBackupModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="padding: 20px;">
                <!-- åˆ›å»ºå¤‡ä»½ -->
                <div style="margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">åˆ›å»ºå¤‡ä»½</h3>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-size: 14px;">å¤‡ä»½æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="backupDescription" placeholder="ä¾‹å¦‚ï¼šé‡è¦æ›´æ–°å‰å¤‡ä»½" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <button class="btn btn-primary" onclick="createBackup()">ğŸ’¾ åˆ›å»ºå¤‡ä»½</button>
                    </div>
                    <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 8px;">
                        ç³»ç»Ÿæ¯24å°æ—¶è‡ªåŠ¨å¤‡ä»½ä¸€æ¬¡ï¼Œæœ€å¤šä¿ç•™20ä¸ªå¤‡ä»½
                    </small>
                </div>

                <!-- å¤‡ä»½åˆ—è¡¨ -->
                <div>
                    <h3 style="margin-bottom: 15px; font-size: 16px;">å¤‡ä»½åˆ—è¡¨</h3>
                    <div id="backupList" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                        <div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯è¯¦æƒ…å¼¹çª— -->
    <div id="itemDetailModal" class="modal mobile-detail-modal">
        <div class="modal-content mobile-detail-content">
            <div class="modal-header mobile-detail-header">
                <h2 id="detailModalTitle" style="font-size: 16px; margin: 0;">é¡¹ç›®è¯¦æƒ…</h2>
                <button type="button" class="close-btn" onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="itemDetailContent" class="mobile-detail-body">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>
            <div class="mobile-detail-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDetailModal()" style="flex: 1; margin-right: 8px;">å…³é—­</button>
                <button type="button" class="btn btn-danger" onclick="deleteFromDetail()" style="flex: 1;">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯å•å­—æ®µç¼–è¾‘å¼¹çª— -->
    <div id="fieldEditModal" class="modal mobile-detail-modal">
        <div class="modal-content mobile-detail-content">
            <div class="modal-header mobile-detail-header">
                <h2 id="fieldEditTitle" style="font-size: 16px; margin: 0;">ç¼–è¾‘</h2>
                <button type="button" class="close-btn" onclick="closeFieldEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="mobile-detail-body" style="padding: 20px;">
                <form id="fieldEditForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label id="fieldEditLabel" style="display: block; margin-bottom: 8px; font-size: 14px; color: #666;">å­—æ®µåç§°</label>
                        <input type="text" id="fieldEditInput" style="width: 100%; padding: 12px; font-size: 16px; border: 1px solid #dee2e6; border-radius: 4px;">
                        <input type="number" id="fieldEditInputNumber" step="0.01" style="display: none; width: 100%; padding: 12px; font-size: 16px; border: 1px solid #dee2e6; border-radius: 4px;">
                        <textarea id="fieldEditTextarea" style="display: none; width: 100%; padding: 12px; font-size: 16px; border: 1px solid #dee2e6; border-radius: 4px; min-height: 100px; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="mobile-detail-actions">
                <button type="button" class="btn btn-secondary" onclick="closeFieldEditModal()" style="flex: 1; margin-right: 8px;">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveFieldEdit()" style="flex: 1;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ é¡¹ç›®</h2>
            </div>
            <form id="itemForm">
                <div class="form-group">
                    <label>åˆ†ç±» *</label>
                    <select name="category" id="categorySelect" required>
                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®åç§° *</label>
                    <input type="text" name="é¡¹ç›®" required placeholder="ä¾‹å¦‚ï¼šå…¨å±‹åŸºç¡€è£…ä¿®">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å•ä½</label>
                        <input type="text" name="å•ä½" placeholder="ä¾‹å¦‚ï¼šå¥—ã€ä¸ªã€ç±³">
                    </div>
                    <div class="form-group">
                        <label>é¢„ç®—æ•°é‡</label>
                        <input type="text" name="é¢„ç®—æ•°é‡" placeholder="ä¾‹å¦‚ï¼š1ã€3">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é¢„ç®—è´¹ç”¨ï¼ˆå…ƒï¼‰</label>
                        <input type="number" name="é¢„ç®—è´¹ç”¨" step="0.01" placeholder="0.00" oninput="calculateDiff()">
                        <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                            åˆå¹¶1stå’Œ2ndé¢„ç®—
                        </small>
                    </div>
                    <div class="form-group">
                        <label>å½“å‰æŠ•å…¥ï¼ˆå…ƒï¼‰</label>
                        <input type="number" name="å½“å‰æŠ•å…¥" step="0.01" placeholder="é»˜è®¤0" oninput="calculateDiff()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æœ€ç»ˆèŠ±è´¹ï¼ˆå…ƒï¼‰</label>
                        <input type="number" name="æœ€ç»ˆèŠ±è´¹" step="0.01" placeholder="é»˜è®¤0" oninput="calculateDiff()">
                    </div>
                    <div class="form-group">
                        <label>å·®ä»·ï¼ˆå…ƒï¼‰</label>
                        <input type="text" name="å·®ä»·" id="diffInput" placeholder="è‡ªåŠ¨è®¡ç®—ï¼ˆé¢„ç®—è´¹ç”¨ - æœ€ç»ˆèŠ±è´¹ï¼‰" readonly style="background: #f8f9fa;">
                        <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                            å·®ä»· = é¢„ç®—è´¹ç”¨ - æœ€ç»ˆèŠ±è´¹ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
                        </small>
                    </div>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea name="å¤‡æ³¨" placeholder="é€‰è´­æ„å‘ã€å“ç‰Œã€å‹å·ç­‰ä¿¡æ¯"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="deleteItemBtn" onclick="deleteCurrentItem()" style="display: none;">åˆ é™¤</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å¯†ç éªŒè¯ç›¸å…³
        // ä½¿ç”¨sessionStorageè€Œä¸æ˜¯localStorageï¼Œå…³é—­æ ‡ç­¾é¡µåéªŒè¯çŠ¶æ€è‡ªåŠ¨å¤±æ•ˆ
        const PASSWORD_STORAGE_KEY = 'budget_app_verified';
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30åˆ†é’Ÿï¼ˆåŒä¸€æ ‡ç­¾é¡µå†…æœ‰æ•ˆï¼‰

        // æ£€æŸ¥æ˜¯å¦å·²é€šè¿‡éªŒè¯
        function checkPasswordVerification() {
            // ä½¿ç”¨sessionStorageï¼Œå…³é—­æ ‡ç­¾é¡µåè‡ªåŠ¨å¤±æ•ˆ
            const verified = sessionStorage.getItem(PASSWORD_STORAGE_KEY);
            if (verified) {
                const timestamp = parseInt(verified);
                const now = Date.now();
                // æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
                if (now - timestamp < SESSION_TIMEOUT) {
                    // éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    return true;
                } else {
                    // è¶…æ—¶ï¼Œæ¸…é™¤éªŒè¯
                    sessionStorage.removeItem(PASSWORD_STORAGE_KEY);
                }
            }
            // æœªéªŒè¯ï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            return false;
        }

        // éªŒè¯å¯†ç 
        async function verifyPassword(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value;
            const errorDiv = document.getElementById('passwordError');

            // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';

            try {
                // è°ƒç”¨åç«¯APIéªŒè¯å¯†ç 
                const response = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                const result = await response.json();
                
                if (result.success) {
                    // éªŒè¯æˆåŠŸï¼Œä¿å­˜éªŒè¯çŠ¶æ€åˆ°sessionStorageï¼ˆå…³é—­æ ‡ç­¾é¡µåå¤±æ•ˆï¼‰
                    sessionStorage.setItem(PASSWORD_STORAGE_KEY, Date.now().toString());
                    // éšè—å¯†ç æ¡†ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    // åŠ è½½æ•°æ®
                    loadData();
                } else {
                    // éªŒè¯å¤±è´¥
                    errorDiv.textContent = result.error || 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                    errorDiv.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (error) {
                errorDiv.textContent = 'éªŒè¯å¤±è´¥: ' + error.message;
                errorDiv.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥éªŒè¯çŠ¶æ€
        (function() {
            if (!checkPasswordVerification()) {
                // å¦‚æœæœªéªŒè¯ï¼Œèšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
                setTimeout(() => {
                    const passwordInput = document.getElementById('passwordInput');
                    if (passwordInput) {
                        passwordInput.focus();
                    }
                }, 100);
            } else {
                // å·²éªŒè¯ï¼ŒåŠ è½½æ•°æ®
                loadData();
            }
        })();

        let categories = [];
        let categoryMap = {};  // åˆ†ç±»å -> IDæ˜ å°„
        let items = [];
        let editingItemId = null;
        let budgetChart = null;
        let actualChart = null;
        let categoryBudgetChart = null;
        let categoryActualChart = null;

        // æ¸²æŸ“é¥¼å›¾
        function renderPieCharts(categoryBudget, categoryActual) {
            // å‡†å¤‡æ•°æ®
            const budgetLabels = [];
            const budgetData = [];
            const actualLabels = [];
            const actualData = [];
            
            // æŒ‰é‡‘é¢æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
            const budgetEntries = Object.entries(categoryBudget)
                .filter(([cat, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);
            const actualEntries = Object.entries(categoryActual)
                .filter(([cat, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);
            
            budgetEntries.forEach(([cat, val]) => {
                budgetLabels.push(cat);
                budgetData.push(val);
            });
            
            actualEntries.forEach(([cat, val]) => {
                actualLabels.push(cat);
                actualData.push(val);
            });
            
            // ç”Ÿæˆé¢œè‰²
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea',
                '#fed6e3', '#a8caba', '#5d4e75', '#ffecd2', '#fcb69f'
            ];
            
            const budgetColors = budgetLabels.map((_, i) => colors[i % colors.length]);
            const actualColors = actualLabels.map((_, i) => colors[i % colors.length]);
            
            // é”€æ¯æ—§å›¾è¡¨
            if (budgetChart) {
                budgetChart.destroy();
            }
            if (actualChart) {
                actualChart.destroy();
            }
            
            // åˆ›å»ºé¢„ç®—é¥¼å›¾
            const budgetCtx = document.getElementById('budgetChart');
            if (budgetCtx && budgetLabels.length > 0) {
                budgetChart = new Chart(budgetCtx, {
                    type: 'pie',
                    data: {
                        labels: budgetLabels,
                        datasets: [{
                            data: budgetData,
                            backgroundColor: budgetColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                align: 'center',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const dataset = data.datasets[0];
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return {
                                                    text: `${label} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    strokeStyle: dataset.borderColor,
                                                    lineWidth: dataset.borderWidth,
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${formatNumber(value)} å…ƒ (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage > 5 ? percentage + '%' : '';
                                }
                            }
                        }
                    }
                });
            }
            
            // åˆ›å»ºå®é™…èŠ±è´¹é¥¼å›¾
            const actualCtx = document.getElementById('actualChart');
            if (actualCtx && actualLabels.length > 0) {
                actualChart = new Chart(actualCtx, {
                    type: 'pie',
                    data: {
                        labels: actualLabels,
                        datasets: [{
                            data: actualData,
                            backgroundColor: actualColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                align: 'center',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const dataset = data.datasets[0];
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return {
                                                    text: `${label} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    strokeStyle: dataset.borderColor,
                                                    lineWidth: dataset.borderWidth,
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${formatNumber(value)} å…ƒ (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage > 5 ? percentage + '%' : '';
                                }
                            }
                        }
                    }
                });
            }
        }

        // æ˜¾ç¤ºåˆ†ç±»é¡¹ç›®é¥¼å›¾
        function showCategoryChart(categoryName) {
            // è·å–è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¡¹ç›®
            const categoryItems = items.filter(item => (item.category || 'æœªåˆ†ç±»') === categoryName);
            
            if (categoryItems.length === 0) {
                showMessage('è¯¥åˆ†ç±»ä¸‹æš‚æ— é¡¹ç›®', 'error');
                return;
            }

            // è®¡ç®—å„é¡¹ç›®çš„é¢„ç®—å’Œå®é™…èŠ±è´¹
            const itemBudget = {};
            const itemActual = {};
            
            categoryItems.forEach(item => {
                const itemName = item['é¡¹ç›®'] || 'æœªå‘½åé¡¹ç›®';
                // å…¼å®¹æ—§æ ¼å¼
                const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨']) || 0;
                const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨']) || 0;
                const budget = parseFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
                let actual = parseFloat(item['æœ€ç»ˆèŠ±è´¹']) || parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']) || 0;
                // å¦‚æœæœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰ï¼Œé‡ç½®ä¸º0
                if (actual === budget && actual > 0) {
                    actual = 0;
                }
                
                if (!itemBudget[itemName]) {
                    itemBudget[itemName] = 0;
                    itemActual[itemName] = 0;
                }
                itemBudget[itemName] += budget;
                itemActual[itemName] += actual;
            });

            // å‡†å¤‡æ•°æ®
            const budgetLabels = [];
            const budgetData = [];
            const actualLabels = [];
            const actualData = [];
            
            // æŒ‰é‡‘é¢æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
            const budgetEntries = Object.entries(itemBudget)
                .filter(([name, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);
            const actualEntries = Object.entries(itemActual)
                .filter(([name, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);
            
            budgetEntries.forEach(([name, val]) => {
                budgetLabels.push(name);
                budgetData.push(val);
            });
            
            actualEntries.forEach(([name, val]) => {
                actualLabels.push(name);
                actualData.push(val);
            });

            // ç”Ÿæˆé¢œè‰²
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea',
                '#fed6e3', '#a8caba', '#5d4e75', '#ffecd2', '#fcb69f'
            ];
            
            const budgetColors = budgetLabels.map((_, i) => colors[i % colors.length]);
            const actualColors = actualLabels.map((_, i) => colors[i % colors.length]);

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('categoryChartTitle').textContent = `${categoryName} - é¡¹ç›®å æ¯”`;

            // é”€æ¯æ—§å›¾è¡¨
            if (categoryBudgetChart) {
                categoryBudgetChart.destroy();
            }
            if (categoryActualChart) {
                categoryActualChart.destroy();
            }

            // åˆ›å»ºé¢„ç®—é¥¼å›¾
            const budgetCtx = document.getElementById('categoryBudgetChart');
            const budgetLegendDiv = document.getElementById('categoryBudgetLegend');
            if (budgetCtx && budgetLabels.length > 0) {
                categoryBudgetChart = new Chart(budgetCtx, {
                    type: 'pie',
                    data: {
                        labels: budgetLabels,
                        datasets: [{
                            data: budgetData,
                            backgroundColor: budgetColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${formatNumber(value)} å…ƒ (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage > 5 ? percentage + '%' : '';
                                }
                            }
                        }
                    }
                });
                
                // åˆ›å»ºè‡ªå®šä¹‰å›¾ä¾‹
                if (budgetLegendDiv) {
                    let legendHtml = '';
                    budgetLabels.forEach((label, i) => {
                        const value = budgetData[i];
                        const total = budgetData.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        legendHtml += `<div style="display: flex; align-items: center; margin-bottom: 6px; padding: 3px;">`;
                        legendHtml += `<div style="width: 14px; height: 14px; background: ${budgetColors[i]}; border-radius: 50%; margin-right: 8px; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);"></div>`;
                        legendHtml += `<div style="flex: 1; font-size: 11px;">`;
                        legendHtml += `<div style="font-weight: 600; color: #333; line-height: 1.3;">${escapeHtml(label)}</div>`;
                        legendHtml += `<div style="font-size: 10px; color: #666;">${formatNumber(value)} å…ƒ (${percentage}%)</div>`;
                        legendHtml += `</div>`;
                        legendHtml += `</div>`;
                    });
                    budgetLegendDiv.innerHTML = legendHtml;
                }
            }

            // åˆ›å»ºå®é™…èŠ±è´¹é¥¼å›¾
            const actualCtx = document.getElementById('categoryActualChart');
            const actualLegendDiv = document.getElementById('categoryActualLegend');
            if (actualCtx && actualLabels.length > 0) {
                categoryActualChart = new Chart(actualCtx, {
                    type: 'pie',
                    data: {
                        labels: actualLabels,
                        datasets: [{
                            data: actualData,
                            backgroundColor: actualColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${formatNumber(value)} å…ƒ (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage > 5 ? percentage + '%' : '';
                                }
                            }
                        }
                    }
                });
                
                // åˆ›å»ºè‡ªå®šä¹‰å›¾ä¾‹
                if (actualLegendDiv) {
                    let legendHtml = '';
                    actualLabels.forEach((label, i) => {
                        const value = actualData[i];
                        const total = actualData.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        legendHtml += `<div style="display: flex; align-items: center; margin-bottom: 6px; padding: 3px;">`;
                        legendHtml += `<div style="width: 14px; height: 14px; background: ${actualColors[i]}; border-radius: 50%; margin-right: 8px; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);"></div>`;
                        legendHtml += `<div style="flex: 1; font-size: 11px;">`;
                        legendHtml += `<div style="font-weight: 600; color: #333; line-height: 1.3;">${escapeHtml(label)}</div>`;
                        legendHtml += `<div style="font-size: 10px; color: #666;">${formatNumber(value)} å…ƒ (${percentage}%)</div>`;
                        legendHtml += `</div>`;
                        legendHtml += `</div>`;
                    });
                    actualLegendDiv.innerHTML = legendHtml;
                }
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('categoryChartModal').classList.add('active');
        }

        // å…³é—­åˆ†ç±»é¡¹ç›®é¥¼å›¾å¼¹çª—
        function closeCategoryChartModal() {
            document.getElementById('categoryChartModal').classList.remove('active');
        }

        // å­—æ®µæ˜¾ç¤ºåç§°æ˜ å°„
        const fieldLabels = {
            'åºå·': 'åºå·',
            'é¡¹ç›®': 'é¡¹ç›®åç§°',
            'å•ä½': 'å•ä½',
            'é¢„ç®—æ•°é‡': 'æ•°é‡',
            'é¢„ç®—è´¹ç”¨': 'é¢„ç®—è´¹ç”¨',
            'å½“å‰æŠ•å…¥': 'å½“å‰æŠ•å…¥',
            'æœ€ç»ˆèŠ±è´¹': 'æœ€ç»ˆèŠ±è´¹',
            'å·®ä»·': 'å·®ä»·',
            'å¤‡æ³¨': 'å¤‡æ³¨'
        };

        // ä¿å­˜å’Œæ¢å¤é¡µé¢çŠ¶æ€
        function savePageState() {
            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            sessionStorage.setItem('pageScrollY', scrollY.toString());
            
            // ä¿å­˜æŠ˜å çŠ¶æ€
            const collapsedCategories = [];
            document.querySelectorAll('.category-section').forEach(section => {
                const content = section.querySelector('.category-content');
                if (content && content.classList.contains('collapsed')) {
                    const category = section.dataset.category;
                    if (category) {
                        collapsedCategories.push(category);
                    }
                }
            });
            sessionStorage.setItem('collapsedCategories', JSON.stringify(collapsedCategories));
        }

        function restorePageState() {
            // æ¢å¤æŠ˜å çŠ¶æ€ï¼ˆå…ˆæ¢å¤ï¼Œå› ä¸ºä¼šå½±å“æ»šåŠ¨ä½ç½®ï¼‰
            const collapsedCategoriesStr = sessionStorage.getItem('collapsedCategories');
            if (collapsedCategoriesStr) {
                try {
                    const collapsedCategories = JSON.parse(collapsedCategoriesStr);
                    collapsedCategories.forEach(category => {
                        const categorySection = document.querySelector(`.category-section[data-category="${category}"]`);
                        if (categorySection) {
                            const content = categorySection.querySelector('.category-content');
                            const toggle = categorySection.querySelector('.category-toggle');
                            if (content && toggle) {
                                content.classList.add('collapsed');
                                toggle.classList.add('collapsed');
                                toggle.textContent = 'â–¶';
                            }
                        }
                    });
                } catch (e) {
                    console.error('æ¢å¤æŠ˜å çŠ¶æ€å¤±è´¥:', e);
                }
            }
            
            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“ï¼‰
            const savedScrollY = sessionStorage.getItem('pageScrollY');
            if (savedScrollY) {
                // å¤šæ¬¡å°è¯•æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿æˆåŠŸ
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScrollY));
                }, 50);
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScrollY));
                }, 200);
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScrollY));
                }, 500);
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData(preserveState = true) {
            // ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€ï¼ˆåœ¨æ¸…ç©ºå†…å®¹ä¹‹å‰ï¼‰
            if (preserveState) {
                savePageState();
            }
            
            const loading = document.getElementById('loading');
            const contentContainer = document.getElementById('contentContainer');
            
            loading.style.display = 'block';
            contentContainer.innerHTML = '';

            try {
                const response = await fetch('/api/load');
                const result = await response.json();

                if (result.success) {
                    categories = result.categories || [];
                    categoryMap = result.category_map || {};  // ä¿å­˜åˆ†ç±»IDæ˜ å°„
                    items = result.items || [];
                    renderContent();
                    updateCategorySelect();
                    
                    // æ¢å¤é¡µé¢çŠ¶æ€ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
                    if (preserveState) {
                        setTimeout(() => {
                            restorePageState();
                        }, 100);
                    }
                } else {
                    showMessage('åŠ è½½å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        // æ¸²æŸ“å†…å®¹
        function renderContent() {
            const container = document.getElementById('contentContainer');
            const itemCount = document.getElementById('itemCount');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p><p style="margin-top: 10px; font-size: 14px;">ç‚¹å‡»"æ·»åŠ é¡¹ç›®"å¼€å§‹æ·»åŠ æ•°æ®</p></div>';
                itemCount.textContent = 'å…± 0 é¡¹';
                return;
            }

            itemCount.textContent = `å…± ${items.length} é¡¹`;

            let html = '';
            
            // æŒ‰åˆ†ç±»ç»„ç»‡æ•°æ®
            const itemsByCategory = {};
            items.forEach(item => {
                const cat = item.category || 'æœªåˆ†ç±»';
                if (!itemsByCategory[cat]) {
                    itemsByCategory[cat] = [];
                }
                itemsByCategory[cat].push(item);
            });

            // æ¸²æŸ“æ¯ä¸ªåˆ†ç±»ï¼ˆæ’é™¤"æœªåˆ†ç±»"ï¼‰
            categories.filter(cat => cat !== 'æœªåˆ†ç±»').forEach(category => {
                const categoryItems = itemsByCategory[category] || [];
                // å³ä½¿æ²¡æœ‰é¡¹ç›®ä¹Ÿæ˜¾ç¤ºåˆ†ç±»ï¼ˆå…è®¸æ·»åŠ é¡¹ç›®ï¼‰
                const categoryId = categoryMap[category];

                html += `<div class="category-section" data-category="${escapeHtml(category)}" data-category-id="${categoryId || ''}">`;
                html += `<div class="category-header">`;
                html += `<div style="flex: 1; display: flex; align-items: center; gap: 8px;">`;
                html += `<span class="category-toggle" onclick="toggleCategory('${escapeHtml(category)}', event)" title="ç‚¹å‡»æŠ˜å /å±•å¼€" style="cursor: pointer; font-size: 16px; user-select: none;">â–¼</span>`;
                html += `<div style="flex: 1; cursor: pointer;" onclick="showCategoryChart('${escapeHtml(category)}')" title="ç‚¹å‡»æŸ¥çœ‹åˆ†ç±»é¡¹ç›®å æ¯”">`;
                html += `<span>${escapeHtml(category)}</span>`;
                html += `<span style="font-size: 14px; opacity: 0.9; margin-left: 8px;">${categoryItems.length} é¡¹ ğŸ“Š</span>`;
                html += `</div>`;
                html += `</div>`;
                // æ·»åŠ åˆ é™¤åˆ†ç±»æŒ‰é’®
                if (categoryId) {
                    html += `<button class="btn-delete-category" onclick="deleteCategory('${escapeHtml(category)}', ${categoryId}, event)" title="åˆ é™¤åˆ†ç±»" style="background: #dc3545; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;">ğŸ—‘ï¸ åˆ é™¤</button>`;
                }
                html += `</div>`;
                html += `<div class="category-content">`;
                html += `<div class="table-wrapper">`;
                html += `<table><thead><tr>`;
                html += `<th class="checkbox-cell"><input type="checkbox" class="category-select-all" onchange="toggleCategorySelectAll('${escapeHtml(category)}', this.checked)"></th>`;
                html += `<th>åºå·</th>`;
                html += `<th class="sortable" data-sort-field="é¡¹ç›®" data-category="${escapeHtml(category)}" onclick="sortItems('${escapeHtml(category)}', 'é¡¹ç›®', this)">é¡¹ç›®åç§° <span class="sort-indicator"></span></th>`;
                html += `<th class="number-cell sortable" data-sort-field="é¢„ç®—è´¹ç”¨" data-category="${escapeHtml(category)}" onclick="sortItems('${escapeHtml(category)}', 'é¢„ç®—è´¹ç”¨', this)">é¢„ç®—è´¹ç”¨ <span class="sort-indicator"></span></th>`;
                html += `<th class="number-cell sortable" data-sort-field="å½“å‰æŠ•å…¥" data-category="${escapeHtml(category)}" onclick="sortItems('${escapeHtml(category)}', 'å½“å‰æŠ•å…¥', this)">å½“å‰æŠ•å…¥ <span class="sort-indicator"></span></th>`;
                html += `<th class="number-cell sortable" data-sort-field="æœ€ç»ˆèŠ±è´¹" data-category="${escapeHtml(category)}" onclick="sortItems('${escapeHtml(category)}', 'æœ€ç»ˆèŠ±è´¹', this)">æœ€ç»ˆèŠ±è´¹ <span class="sort-indicator"></span></th>`;
                html += `<th class="number-cell sortable" data-sort-field="å·®ä»·" data-category="${escapeHtml(category)}" onclick="sortItems('${escapeHtml(category)}', 'å·®ä»·', this)">å·®ä»· <span class="sort-indicator"></span></th>`;
                html += `<th>å•ä½</th>`;
                html += `<th>æ•°é‡</th>`;
                html += `<th>å¤‡æ³¨</th>`;
                html += `<th class="action-cell desktop-only">æ“ä½œ</th>`;
                html += `</tr></thead><tbody>`;

                let categoryTotalBudget = 0;
                let categoryTotalCurrent = 0;
                let categoryTotalFinal = 0;
                let categoryTotalDiff = 0;
                
                if (categoryItems.length === 0) {
                    // ç©ºåˆ†ç±»æ˜¾ç¤ºæç¤º
                    html += `<tr><td colspan="11" style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— é¡¹ç›®ï¼Œç‚¹å‡»"æ·»åŠ é¡¹ç›®"å¼€å§‹æ·»åŠ </td></tr>`;
                } else {
                    // æŒ‰åºå·æ’åºï¼ˆå¦‚æœåºå·ç›¸åŒï¼ŒæŒ‰IDæ’åºï¼‰
                    categoryItems.sort((a, b) => {
                        const seqA = parseInt(a['åºå·']) || 0;
                        const seqB = parseInt(b['åºå·']) || 0;
                        if (seqA !== seqB) {
                            return seqA - seqB;
                        }
                        return a.id - b.id;
                    });
                    
                    // æŒ‰æ˜¾ç¤ºé¡ºåºè®¡ç®—åºå·ï¼ˆ1, 2, 3...ï¼‰
                    categoryItems.forEach((item, index) => {
                        const displaySeqNum = index + 1;  // æ˜¾ç¤ºåºå·ä»1å¼€å§‹
                        
                        // å®‰å…¨è§£ææ•°å€¼ï¼šå¤„ç†ç©ºå­—ç¬¦ä¸²ã€nullã€undefinedç­‰æƒ…å†µ
                        const parseSafeFloat = (val) => {
                            if (val === '' || val === null || val === undefined) return 0;
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        };
                        
                        // å…¼å®¹æ—§æ ¼å¼
                        const val1st = parseSafeFloat(item['1sté¢„ç®—è´¹ç”¨']);
                        const val2nd = parseSafeFloat(item['2ndé¢„ç®—è´¹ç”¨']);
                        const valBudget = parseSafeFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
                        const valCurrent = parseSafeFloat(item['å½“å‰æŠ•å…¥']) || parseSafeFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']);
                        // ç›´æ¥ä½¿ç”¨æœ€ç»ˆèŠ±è´¹çš„å€¼ï¼Œä¸å†é‡ç½®ä¸º0ï¼ˆç”¨æˆ·å¯èƒ½ç¡®å®è®¾ç½®äº†æœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼‰
                        let valFinal = parseSafeFloat(item['æœ€ç»ˆèŠ±è´¹']);
                        const valDiff = valBudget - valFinal;
                        
                        categoryTotalBudget += valBudget;
                        categoryTotalCurrent += valCurrent;
                        categoryTotalFinal += valFinal;
                        categoryTotalDiff += valDiff;
                        
                        html += `<tr data-item-id="${item.id}" data-category="${escapeHtml(category)}">`;
                        html += `<td class="checkbox-cell"><input type="checkbox" class="row-checkbox" onchange="updateDeleteButton()"></td>`;
                        html += `<td>${displaySeqNum}</td>`;
                        html += `<td><strong>${escapeHtml(item['é¡¹ç›®'] || '')}</strong></td>`;
                        html += `<td class="number-cell">${formatNumber(valBudget)}</td>`;
                        html += `<td class="number-cell">${formatNumber(valCurrent)}</td>`;
                        html += `<td class="number-cell"><strong>${formatNumber(valFinal)}</strong></td>`;
                        html += `<td class="number-cell">${formatNumber(valDiff)}</td>`;
                        html += `<td>${escapeHtml(item['å•ä½'] || '')}</td>`;
                        html += `<td>${escapeHtml(item['é¢„ç®—æ•°é‡'] || '')}</td>`;
                        html += `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item['å¤‡æ³¨'] || '')}">${escapeHtml(item['å¤‡æ³¨'] || '')}</td>`;
                        html += `<td class="action-cell desktop-only"><button class="btn btn-primary btn-small" onclick="event.stopPropagation(); editItem(${item.id})">ç¼–è¾‘</button></td>`;
                        html += `</tr>`;
                    });
                }

                html += `</tbody></table>`;
                html += `<div class="summary">`;
                html += `<span>æœ¬åˆ†ç±»åˆè®¡ï¼š`;
                html += `é¢„ç®—è´¹ç”¨ <strong>${formatNumber(categoryTotalBudget)}</strong> å…ƒ | `;
                html += `å½“å‰æŠ•å…¥ <strong>${formatNumber(categoryTotalCurrent)}</strong> å…ƒ | `;
                html += `æœ€ç»ˆèŠ±è´¹ <strong>${formatNumber(categoryTotalFinal)}</strong> å…ƒ | `;
                html += `å·®ä»· <strong>${formatNumber(categoryTotalDiff)}</strong> å…ƒ`;
                html += `</span>`;
                html += `</div>`;
                html += `</div></div></div>`;
            });

            // ä¸å†æ¸²æŸ“æœªåˆ†ç±»é¡¹ç›®ï¼ˆå·²å‰”é™¤ï¼‰

            // è®¡ç®—æ€»åˆè®¡ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
            let grandTotalBudget = 0;
            let grandTotalCurrent = 0;
            let grandTotalFinal = 0;
            let grandTotalDiff = 0;
            
            items.forEach(item => {
                const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨']) || 0;
                const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨']) || 0;
                const valBudget = parseFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
                const valCurrent = parseFloat(item['å½“å‰æŠ•å…¥']) || parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']) || 0;
                // ç¡®ä¿æœ€ç»ˆèŠ±è´¹é»˜è®¤ä¸º0ï¼Œä¸èƒ½ç­‰äºé¢„ç®—
                let valFinal = parseFloat(item['æœ€ç»ˆèŠ±è´¹']) || 0;
                // å¦‚æœæœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰ï¼Œé‡ç½®ä¸º0
                if (valFinal === valBudget && valFinal > 0) {
                    valFinal = 0;
                }
                const valDiff = parseFloat(item['å·®ä»·']) || (valBudget - valFinal);
                
                grandTotalBudget += valBudget;
                grandTotalCurrent += valCurrent;
                grandTotalFinal += valFinal;
                grandTotalDiff += valDiff;
            });

            // è®¡ç®—å„åˆ†ç±»çš„é¢„ç®—å’Œå®é™…èŠ±è´¹ï¼ˆç”¨äºé¥¼å›¾ï¼‰
            const categoryBudget = {};
            const categoryActual = {};
            
            items.forEach(item => {
                const cat = item.category || 'æœªåˆ†ç±»';
                // è·³è¿‡æœªåˆ†ç±»é¡¹ç›®ï¼Œä¸æ˜¾ç¤ºåœ¨é¥¼å›¾ä¸­
                if (cat === 'æœªåˆ†ç±»') {
                    return;
                }
                const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨']) || 0;
                const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨']) || 0;
                const budget = parseFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
                let actual = parseFloat(item['æœ€ç»ˆèŠ±è´¹']) || parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']) || 0;
                // å¦‚æœæœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰ï¼Œé‡ç½®ä¸º0
                if (actual === budget && actual > 0) {
                    actual = 0;
                }
                
                if (!categoryBudget[cat]) {
                    categoryBudget[cat] = 0;
                    categoryActual[cat] = 0;
                }
                categoryBudget[cat] += budget;
                categoryActual[cat] += actual;
            });

            // åœ¨å¼€å¤´æ·»åŠ æ€»åˆè®¡æ˜¾ç¤ºå’Œé¥¼å›¾
            let totalHtml = '';
            totalHtml += `<div class="category-section" style="background: #f8f9fa; border: 2px solid #667eea; margin-bottom: 20px;">`;
            totalHtml += `<div class="category-header" style="background: #667eea; color: white; padding: 15px; font-size: 18px; font-weight: bold;">`;
            totalHtml += `<span>ğŸ“Š æ€»è®¡</span>`;
            totalHtml += `</div>`;
            totalHtml += `<div class="summary" style="padding: 20px; font-size: 16px; text-align: center;">`;
            totalHtml += `<div style="font-weight: 600; margin-bottom: 10px;">æ€»åˆè®¡</div>`;
            totalHtml += `<div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center;">`;
            totalHtml += `<div style="text-align: center;"><div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">é¢„ç®—è´¹ç”¨</div><strong style="color: #667eea; font-size: 20px;">${formatNumber(grandTotalBudget)}</strong><span style="font-size: 12px; color: #6c757d;"> å…ƒ</span></div>`;
            totalHtml += `<div style="text-align: center;"><div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">å½“å‰æŠ•å…¥</div><strong style="color: #ff9800; font-size: 20px;">${formatNumber(grandTotalCurrent)}</strong><span style="font-size: 12px; color: #6c757d;"> å…ƒ</span></div>`;
            totalHtml += `<div style="text-align: center;"><div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">æœ€ç»ˆèŠ±è´¹</div><strong style="color: #28a745; font-size: 20px;">${formatNumber(grandTotalFinal)}</strong><span style="font-size: 12px; color: #6c757d;"> å…ƒ</span></div>`;
            totalHtml += `<div style="text-align: center;"><div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">å·®ä»·</div><strong style="color: ${grandTotalDiff >= 0 ? '#28a745' : '#dc3545'}; font-size: 20px;">${formatNumber(grandTotalDiff)}</strong><span style="font-size: 12px; color: #6c757d;"> å…ƒ</span></div>`;
            totalHtml += `</div>`;
            
            // æ·»åŠ é¢„ç®—è¿›åº¦æ¡
            if (grandTotalBudget > 0) {
                const progressPercent = Math.min((grandTotalCurrent / grandTotalBudget) * 100, 100);
                const progressColor = progressPercent > 100 ? '#dc3545' : (progressPercent > 80 ? '#ff9800' : '#28a745');
                totalHtml += `<div style="margin-top: 20px; padding: 0 10px;">`;
                totalHtml += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                totalHtml += `<span style="font-size: 13px; color: #6c757d; font-weight: 500;">é¢„ç®—è¿›åº¦</span>`;
                totalHtml += `<span style="font-size: 13px; color: #333; font-weight: 600;">${progressPercent.toFixed(1)}%</span>`;
                totalHtml += `</div>`;
                totalHtml += `<div style="width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">`;
                totalHtml += `<div style="width: ${progressPercent}%; height: 100%; background: linear-gradient(90deg, ${progressColor} 0%, ${progressColor}dd 100%); border-radius: 12px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">`;
                if (progressPercent > 15) {
                    totalHtml += `<span style="color: white; font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${formatNumber(grandTotalCurrent)} / ${formatNumber(grandTotalBudget)}</span>`;
                }
                totalHtml += `</div>`;
                totalHtml += `</div>`;
                totalHtml += `</div>`;
            }
            
            totalHtml += `</div>`;
            
            // æ·»åŠ é¥¼å›¾å®¹å™¨
            totalHtml += `<div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; padding: 20px; background: white;">`;
            totalHtml += `<div style="flex: 1; min-width: 300px; max-width: 400px;">`;
            totalHtml += `<div style="text-align: center; font-weight: 600; margin-bottom: 10px; font-size: 16px;">é¢„ç®—è´¹ç”¨åˆ†ç±»å æ¯”</div>`;
            totalHtml += `<canvas id="budgetChart" style="max-width: 100%; height: auto;"></canvas>`;
            totalHtml += `</div>`;
            totalHtml += `<div style="flex: 1; min-width: 300px; max-width: 400px;">`;
            totalHtml += `<div style="text-align: center; font-weight: 600; margin-bottom: 10px; font-size: 16px;">æœ€ç»ˆèŠ±è´¹åˆ†ç±»å æ¯”</div>`;
            totalHtml += `<canvas id="actualChart" style="max-width: 100%; height: auto;"></canvas>`;
            totalHtml += `</div>`;
            totalHtml += `</div>`;
            totalHtml += `</div>`;

            container.innerHTML = totalHtml + html;
            
            // æ¸²æŸ“é¥¼å›¾
            renderPieCharts(categoryBudget, categoryActual);
            
            // ç§»åŠ¨ç«¯ï¼šä¸ºè¡¨æ ¼è¡Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ•´è¡Œå¯ç‚¹å‡»ç¼–è¾‘ï¼‰
            // ç§»åŠ¨ç«¯å·²éšè—å¤é€‰æ¡†ï¼Œæ‰€ä»¥æ•´è¡Œéƒ½å¯ä»¥ç‚¹å‡»
            document.querySelectorAll('tbody tr[data-item-id]').forEach(row => {
                const itemId = row.dataset.itemId;
                if (itemId) {
                    // ç§»åŠ¨ç«¯ï¼šæ•´è¡Œå¯ç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…
                    if (window.innerWidth <= 768) {
                        row.addEventListener('click', function(e) {
                            showItemDetail(parseInt(itemId));
                        });
                        row.style.transition = 'background 0.2s';
                    } else {
                        // æ¡Œé¢ç«¯ï¼šåªæœ‰ç‚¹å‡»éå¤é€‰æ¡†åŒºåŸŸæ‰ç¼–è¾‘
                        row.addEventListener('click', function(e) {
                            if (e.target.type === 'checkbox' || e.target.closest('.checkbox-cell') || e.target.closest('.action-cell')) {
                                return;
                            }
                            editItem(parseInt(itemId));
                        });
                    }
                }
            });
        }

        // æ›´æ–°åˆ†ç±»é€‰æ‹©å™¨
        function updateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
            });
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ é¡¹ç›®';
            document.getElementById('itemForm').reset();
            // éšè—åˆ é™¤æŒ‰é’®ï¼ˆæ·»åŠ æ¨¡å¼ï¼‰
            document.getElementById('deleteItemBtn').style.display = 'none';
            document.getElementById('itemModal').classList.add('active');
            if (window.innerWidth <= 768) {
                document.getElementById('itemModal').style.display = 'flex';
            }
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            editingItemId = itemId;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
            
            // å¡«å……è¡¨å•
            document.getElementById('categorySelect').value = item.category || '';
            document.querySelector('[name="é¡¹ç›®"]').value = item['é¡¹ç›®'] || '';
            document.querySelector('[name="å•ä½"]').value = item['å•ä½'] || '';
            document.querySelector('[name="é¢„ç®—æ•°é‡"]').value = item['é¢„ç®—æ•°é‡'] || '';
            // å…¼å®¹æ—§æ ¼å¼ï¼šä¼˜å…ˆä½¿ç”¨æ–°å­—æ®µï¼Œå¦åˆ™åˆå¹¶1stå’Œ2nd
            const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨']) || 0;
            const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨']) || 0;
            const valBudget = parseFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
            
            // å½“å‰æŠ•å…¥ï¼šä¼˜å…ˆä½¿ç”¨æ–°å­—æ®µï¼Œå¦åˆ™ä½¿ç”¨æ—§å­—æ®µ"æœ€ç»ˆå®é™…èŠ±è´¹"
            // ä½†è¦ç¡®ä¿ä¸ç­‰äºé¢„ç®—è´¹ç”¨ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰
            let valCurrent = 0;
            if (item['å½“å‰æŠ•å…¥'] && item['å½“å‰æŠ•å…¥'] !== '') {
                valCurrent = parseFloat(item['å½“å‰æŠ•å…¥']) || 0;
            } else if (item['æœ€ç»ˆå®é™…èŠ±è´¹'] && item['æœ€ç»ˆå®é™…èŠ±è´¹'] !== '') {
                const valOldActual = parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']) || 0;
                // å¦‚æœæ—§çš„å®é™…èŠ±è´¹ç­‰äºé¢„ç®—ï¼Œè¯´æ˜å¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼Œè®¾ä¸º0
                if (Math.abs(valOldActual - valBudget) > 0.01 || valBudget === 0) {
                    valCurrent = valOldActual;
                }
            }
            
            // å®‰å…¨è§£ææ•°å€¼ï¼šå¤„ç†ç©ºå­—ç¬¦ä¸²ã€nullã€undefinedç­‰æƒ…å†µ
            const parseSafeFloat = (val) => {
                if (val === '' || val === null || val === undefined) return 0;
                const num = parseFloat(val);
                return isNaN(num) ? 0 : num;
            };
            
            // ç›´æ¥ä½¿ç”¨æœ€ç»ˆèŠ±è´¹çš„å€¼ï¼Œä¸å†é‡ç½®ä¸º0ï¼ˆç”¨æˆ·å¯èƒ½ç¡®å®è®¾ç½®äº†æœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼‰
            let valFinal = parseSafeFloat(item['æœ€ç»ˆèŠ±è´¹']);
            // å¡«å……è¡¨å•å­—æ®µï¼ˆ0å€¼ä¹Ÿè¦æ˜¾ç¤ºï¼Œä¸èƒ½è½¬ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
            const budgetField = document.querySelector('[name="é¢„ç®—è´¹ç”¨"]');
            const currentField = document.querySelector('[name="å½“å‰æŠ•å…¥"]');
            const finalField = document.querySelector('[name="æœ€ç»ˆèŠ±è´¹"]');
            const remarkField = document.querySelector('[name="å¤‡æ³¨"]');
            
            // ä½¿ç”¨Number.isNaNæ£€æŸ¥ï¼Œç¡®ä¿0å€¼ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
            if (budgetField) budgetField.value = (!isNaN(valBudget) && valBudget !== null) ? valBudget : '';
            if (currentField) currentField.value = (!isNaN(valCurrent) && valCurrent !== null) ? valCurrent : '';
            if (finalField) finalField.value = (!isNaN(valFinal) && valFinal !== null) ? valFinal : '';
            if (remarkField) remarkField.value = item['å¤‡æ³¨'] || '';
            
            // è‡ªåŠ¨è®¡ç®—å·®ä»·
            calculateDiff();
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            document.getElementById('deleteItemBtn').style.display = 'inline-block';
            
            document.getElementById('itemModal').classList.add('active');
        }

        // è®¡ç®—å·®ä»·
        function calculateDiff() {
            const valBudget = parseFloat(document.querySelector('[name="é¢„ç®—è´¹ç”¨"]').value) || 0;
            const valFinal = parseFloat(document.querySelector('[name="æœ€ç»ˆèŠ±è´¹"]').value) || 0;
            const diff = valBudget - valFinal;
            const diffInput = document.getElementById('diffInput');
            if (diffInput) {
                diffInput.value = Math.round(diff);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
            editingItemId = null;
            document.getElementById('deleteItemBtn').style.display = 'none';
            if (window.innerWidth <= 768) {
                document.getElementById('itemModal').style.display = 'none';
            }
        }

        // åˆ é™¤å½“å‰ç¼–è¾‘çš„é¡¹ç›®
        async function deleteCurrentItem() {
            if (editingItemId === null) return;

            const item = items.find(i => i.id === editingItemId);
            const itemName = item ? item['é¡¹ç›®'] : 'è¯¥é¡¹ç›®';

            // ç¬¬ä¸€æ¬¡ç¡®è®¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${itemName}"å—ï¼Ÿ`)) {
                return;
            }

            // ç¬¬äºŒæ¬¡ç¡®è®¤
            if (!confirm(`è¯·å†æ¬¡ç¡®è®¤ï¼šç¡®å®šè¦åˆ é™¤"${itemName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: [editingItemId] })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeModal();
                    loadData();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…ï¼ˆç§»åŠ¨ç«¯ï¼‰
        let currentDetailItemId = null;
        function showItemDetail(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            currentDetailItemId = itemId;
            // ä¿å­˜åˆ°sessionStorageï¼Œç”¨äºå•å­—æ®µç¼–è¾‘åæ¢å¤
            sessionStorage.setItem('currentEditingItemId', itemId.toString());
            const detailContent = document.getElementById('itemDetailContent');
            const title = document.getElementById('detailModalTitle');

            title.textContent = item['é¡¹ç›®'] || 'é¡¹ç›®è¯¦æƒ…';

            // æ„å»ºè¯¦æƒ…å†…å®¹ï¼Œå­—æ®µé¡ºåºï¼šé¡¹ç›®åç§°ã€é¢„ç®—è´¹ç”¨ã€å½“å‰æŠ•å…¥ã€æœ€ç»ˆèŠ±è´¹ã€å·®ä»·ã€å•ä½ã€æ•°é‡ã€å¤‡æ³¨
            // å…¼å®¹æ—§æ ¼å¼
            const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨']) || 0;
            const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨']) || 0;
            const valBudget = parseFloat(item['é¢„ç®—è´¹ç”¨']) || (val2nd > 0 ? val2nd : val1st);
            const valCurrent = parseFloat(item['å½“å‰æŠ•å…¥']) || parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹']) || 0;
            // ç›´æ¥ä½¿ç”¨æœ€ç»ˆèŠ±è´¹çš„å€¼ï¼Œä¸å†é‡ç½®ä¸º0ï¼ˆå› ä¸ºç”¨æˆ·å¯èƒ½ç¡®å®è®¾ç½®äº†æœ€ç»ˆèŠ±è´¹ç­‰äºé¢„ç®—ï¼‰
            let valFinal = parseFloat(item['æœ€ç»ˆèŠ±è´¹']) || 0;
            const valDiff = valBudget - valFinal;
            
            let html = '';
            // æ¯ä¸ªå­—æ®µéƒ½å¯ä»¥ç‚¹å‡»ç¼–è¾‘ï¼Œæ·»åŠ  data-field å±æ€§ç”¨äºè¯†åˆ«å­—æ®µ
            html += `<div class="mobile-detail-item" data-field="é¡¹ç›®" onclick="editFieldFromDetail('é¡¹ç›®')"><span class="mobile-detail-label">é¡¹ç›®åç§°</span><span class="mobile-detail-value">${escapeHtml(item['é¡¹ç›®'] || '-')}</span></div>`;
            html += `<div class="mobile-detail-item" data-field="é¢„ç®—è´¹ç”¨" onclick="editFieldFromDetail('é¢„ç®—è´¹ç”¨')"><span class="mobile-detail-label">é¢„ç®—è´¹ç”¨</span><span class="mobile-detail-value">${formatNumber(valBudget)} å…ƒ</span></div>`;
            html += `<div class="mobile-detail-item" data-field="å½“å‰æŠ•å…¥" onclick="editFieldFromDetail('å½“å‰æŠ•å…¥')"><span class="mobile-detail-label">å½“å‰æŠ•å…¥</span><span class="mobile-detail-value">${formatNumber(valCurrent)} å…ƒ</span></div>`;
            html += `<div class="mobile-detail-item" data-field="æœ€ç»ˆèŠ±è´¹" onclick="editFieldFromDetail('æœ€ç»ˆèŠ±è´¹')"><span class="mobile-detail-label">æœ€ç»ˆèŠ±è´¹</span><span class="mobile-detail-value">${formatNumber(valFinal)} å…ƒ</span></div>`;
            // å·®ä»·æ˜¯åªè¯»çš„ï¼Œä¸æ·»åŠ ç‚¹å‡»äº‹ä»¶
            html += `<div class="mobile-detail-item" style="cursor: default;"><span class="mobile-detail-label">å·®ä»·</span><span class="mobile-detail-value" style="color: ${valDiff >= 0 ? '#28a745' : '#dc3545'};"><span style="display: none;">â€º</span>${formatNumber(valDiff)} å…ƒ</span></div>`;
            html += `<div class="mobile-detail-item" data-field="å•ä½" onclick="editFieldFromDetail('å•ä½')"><span class="mobile-detail-label">å•ä½</span><span class="mobile-detail-value">${escapeHtml(item['å•ä½'] || '-')}</span></div>`;
            html += `<div class="mobile-detail-item" data-field="é¢„ç®—æ•°é‡" onclick="editFieldFromDetail('é¢„ç®—æ•°é‡')"><span class="mobile-detail-label">æ•°é‡</span><span class="mobile-detail-value">${escapeHtml(item['é¢„ç®—æ•°é‡'] || '-')}</span></div>`;
            // å¤‡æ³¨å§‹ç»ˆæ˜¾ç¤ºï¼Œå³ä½¿ä¸ºç©ºä¹Ÿæ˜¾ç¤º
            html += `<div class="mobile-detail-item" data-field="å¤‡æ³¨" onclick="editFieldFromDetail('å¤‡æ³¨')"><span class="mobile-detail-label">å¤‡æ³¨</span><span class="mobile-detail-value" style="text-align: left; white-space: normal; word-break: break-word;">${escapeHtml(item['å¤‡æ³¨'] || '-')}</span></div>`;

            detailContent.innerHTML = html;
            document.getElementById('itemDetailModal').classList.add('active');
            
            // æ·»åŠ æµè§ˆå™¨å†å²è®°å½•ï¼Œæ”¯æŒåé€€é”®å…³é—­ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
            if (window.innerWidth <= 768) {
                window.history.pushState({ detailView: true }, '', window.location.href);
            }
        }

        // å…³é—­è¯¦æƒ…å¼¹çª—
        function closeDetailModal() {
            document.getElementById('itemDetailModal').classList.remove('active');
            currentDetailItemId = null;
            // æ¸…é™¤sessionStorageä¸­çš„ç¼–è¾‘é¡¹IDï¼ˆåªæœ‰åœ¨çœŸæ­£å…³é—­è¯¦æƒ…æ—¶æ‰æ¸…é™¤ï¼‰
            sessionStorage.removeItem('currentEditingItemId');
            // ä»æµè§ˆå™¨å†å²è®°å½•ä¸­ç§»é™¤è¯¦æƒ…ç•Œé¢çŠ¶æ€
            if (window.history.state && window.history.state.detailView) {
                window.history.back();
            }
        }

        // ç›‘å¬æµè§ˆå™¨åé€€é”®
        window.addEventListener('popstate', function(event) {
            // å¦‚æœå½“å‰æ˜¾ç¤ºè¯¦æƒ…ç•Œé¢ï¼Œå…³é—­å®ƒ
            const detailModal = document.getElementById('itemDetailModal');
            if (detailModal && detailModal.classList.contains('active')) {
                detailModal.classList.remove('active');
                currentDetailItemId = null;
            }
        });

        // ä»è¯¦æƒ…å¼¹çª—ç¼–è¾‘æŒ‡å®šå­—æ®µï¼ˆå•å­—æ®µç¼–è¾‘ï¼‰
        function editFieldFromDetail(fieldName) {
            if (currentDetailItemId === null) return;
            
            // ä¿å­˜å½“å‰è¯¦æƒ…é¡¹IDï¼ˆå› ä¸ºcloseDetailModalä¼šæ¸…ç©ºå®ƒï¼‰
            const savedDetailItemId = currentDetailItemId;
            
            const item = items.find(i => i.id === currentDetailItemId);
            if (!item) return;
            
            // å­—æ®µåç§°æ˜ å°„
            const fieldLabels = {
                'é¡¹ç›®': 'é¡¹ç›®åç§°',
                'é¢„ç®—è´¹ç”¨': 'é¢„ç®—è´¹ç”¨ï¼ˆå…ƒï¼‰',
                'å½“å‰æŠ•å…¥': 'å½“å‰æŠ•å…¥ï¼ˆå…ƒï¼‰',
                'æœ€ç»ˆèŠ±è´¹': 'æœ€ç»ˆèŠ±è´¹ï¼ˆå…ƒï¼‰',
                'å•ä½': 'å•ä½',
                'é¢„ç®—æ•°é‡': 'æ•°é‡',
                'å¤‡æ³¨': 'å¤‡æ³¨'
            };
            
            const fieldLabel = fieldLabels[fieldName] || fieldName;
            let fieldValue = item[fieldName] || '';
            
            // æ•°å€¼å­—æ®µéœ€è¦ç‰¹æ®Šå¤„ç†
            if (fieldName === 'é¢„ç®—è´¹ç”¨' || fieldName === 'å½“å‰æŠ•å…¥' || fieldName === 'æœ€ç»ˆèŠ±è´¹') {
                fieldValue = parseFloat(fieldValue) || 0;
            }
            
            // è®¾ç½®æ ‡é¢˜å’Œæ ‡ç­¾
            document.getElementById('fieldEditTitle').textContent = `ç¼–è¾‘${fieldLabel}`;
            document.getElementById('fieldEditLabel').textContent = fieldLabel;
            
            // æ ¹æ®å­—æ®µç±»å‹æ˜¾ç¤ºä¸åŒçš„è¾“å…¥æ¡†
            const textInput = document.getElementById('fieldEditInput');
            const numberInput = document.getElementById('fieldEditInputNumber');
            const textareaInput = document.getElementById('fieldEditTextarea');
            
            // éšè—æ‰€æœ‰è¾“å…¥æ¡†
            textInput.style.display = 'none';
            numberInput.style.display = 'none';
            textareaInput.style.display = 'none';
            
            // æ ¹æ®å­—æ®µç±»å‹æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥æ¡†
            if (fieldName === 'å¤‡æ³¨') {
                textareaInput.style.display = 'block';
                textareaInput.value = fieldValue;
                textareaInput.setAttribute('data-field-name', fieldName);
            } else if (fieldName === 'é¢„ç®—è´¹ç”¨' || fieldName === 'å½“å‰æŠ•å…¥' || fieldName === 'æœ€ç»ˆèŠ±è´¹') {
                numberInput.style.display = 'block';
                numberInput.value = fieldValue;
                numberInput.setAttribute('data-field-name', fieldName);
            } else {
                textInput.style.display = 'block';
                textInput.value = fieldValue;
                textInput.setAttribute('data-field-name', fieldName);
            }
            
            // ä¿å­˜å½“å‰è¯¦æƒ…é¡¹IDåˆ°sessionStorageï¼ˆå› ä¸ºcloseDetailModalä¼šæ¸…ç©ºcurrentDetailItemIdï¼‰
            sessionStorage.setItem('currentEditingItemId', savedDetailItemId.toString());
            
            // å…³é—­è¯¦æƒ…å¼¹çª—
            document.getElementById('itemDetailModal').classList.remove('active');
            
            // æ˜¾ç¤ºå•å­—æ®µç¼–è¾‘å¼¹çª—
            document.getElementById('fieldEditModal').classList.add('active');
            
            // å»¶è¿Ÿèšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const activeInput = textInput.style.display !== 'none' ? textInput : 
                                   (numberInput.style.display !== 'none' ? numberInput : textareaInput);
                activeInput.focus();
                if (activeInput.type === 'text' || activeInput.tagName === 'TEXTAREA') {
                    activeInput.select();
                }
            }, 300);
        }
        
        // å…³é—­å•å­—æ®µç¼–è¾‘å¼¹çª—
        function closeFieldEditModal() {
            document.getElementById('fieldEditModal').classList.remove('active');
            document.getElementById('fieldEditForm').reset();
            // è¿”å›è¯¦æƒ…é¡µé¢ï¼ˆä»sessionStorageæ¢å¤itemIdï¼‰
            const savedItemId = sessionStorage.getItem('currentEditingItemId');
            if (savedItemId) {
                const itemId = parseInt(savedItemId);
                setTimeout(() => {
                    showItemDetail(itemId);
                }, 100);
            }
        }
        
        // ä¿å­˜å•å­—æ®µç¼–è¾‘
        async function saveFieldEdit() {
            // ä»sessionStorageè·å–itemIdï¼ˆå› ä¸ºcurrentDetailItemIdå¯èƒ½å·²è¢«æ¸…ç©ºï¼‰
            const savedItemIdStr = sessionStorage.getItem('currentEditingItemId');
            if (!savedItemIdStr) {
                showMessage('æ— æ³•è·å–é¡¹ç›®ID', 'error');
                return;
            }
            
            const itemId = parseInt(savedItemIdStr);
            if (!itemId || isNaN(itemId)) {
                showMessage('é¡¹ç›®IDæ— æ•ˆ', 'error');
                return;
            }
            
            const textInput = document.getElementById('fieldEditInput');
            const numberInput = document.getElementById('fieldEditInputNumber');
            const textareaInput = document.getElementById('fieldEditTextarea');
            
            // è·å–å½“å‰æ˜¾ç¤ºçš„è¾“å…¥æ¡†
            let activeInput = null;
            let fieldName = null;
            
            if (textInput.style.display !== 'none') {
                activeInput = textInput;
                fieldName = textInput.getAttribute('data-field-name');
            } else if (numberInput.style.display !== 'none') {
                activeInput = numberInput;
                fieldName = numberInput.getAttribute('data-field-name');
            } else if (textareaInput.style.display !== 'none') {
                activeInput = textareaInput;
                fieldName = textareaInput.getAttribute('data-field-name');
            }
            
            if (!activeInput || !fieldName) {
                showMessage('æ— æ³•è·å–å­—æ®µä¿¡æ¯', 'error');
                return;
            }
            
            const newValue = activeInput.value;
            // ä»itemsæ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„é¡¹ç›®ï¼ˆå¦‚æœitemså·²åŠ è½½ï¼‰
            const item = items.find(i => i.id === itemId);
            
            // æ„å»ºæ›´æ–°æ•°æ®ï¼Œå¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
            const updateData = {
                id: itemId
            };
            
            // å¦‚æœitemsä¸­æœ‰è¯¥é¡¹ç›®ï¼Œä¿ç•™å…¶ä»–å­—æ®µçš„å€¼
            if (item) {
                // ä¿ç•™åŸæœ‰å­—æ®µå€¼
                // æ³¨æ„ï¼šåç«¯å¯èƒ½è¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆè¡¨ç¤º0ï¼‰ï¼Œéœ€è¦æ­£ç¡®è§£æ
                updateData['é¡¹ç›®'] = item['é¡¹ç›®'] || '';
                updateData['å•ä½'] = item['å•ä½'] || '';
                updateData['é¢„ç®—æ•°é‡'] = item['é¢„ç®—æ•°é‡'] || '';
                // å®‰å…¨è§£ææ•°å€¼ï¼šç©ºå­—ç¬¦ä¸²ã€nullã€undefined éƒ½è½¬ä¸º 0
                const parseSafeFloat = (val) => {
                    if (val === '' || val === null || val === undefined) return 0;
                    const num = parseFloat(val);
                    return isNaN(num) ? 0 : num;
                };
                updateData['é¢„ç®—è´¹ç”¨'] = parseSafeFloat(item['é¢„ç®—è´¹ç”¨']);
                updateData['å½“å‰æŠ•å…¥'] = parseSafeFloat(item['å½“å‰æŠ•å…¥']);
                updateData['æœ€ç»ˆèŠ±è´¹'] = parseSafeFloat(item['æœ€ç»ˆèŠ±è´¹']);
                updateData['å¤‡æ³¨'] = item['å¤‡æ³¨'] || '';
            } else {
                // å¦‚æœitemsä¸­æ²¡æœ‰ï¼Œè®¾ç½®é»˜è®¤å€¼
                updateData['é¡¹ç›®'] = '';
                updateData['å•ä½'] = '';
                updateData['é¢„ç®—æ•°é‡'] = '';
                updateData['é¢„ç®—è´¹ç”¨'] = 0;
                updateData['å½“å‰æŠ•å…¥'] = 0;
                updateData['æœ€ç»ˆèŠ±è´¹'] = 0;
                updateData['å¤‡æ³¨'] = '';
            }
            
            // æ›´æ–°å¯¹åº”å­—æ®µçš„å€¼
            if (fieldName === 'é¢„ç®—è´¹ç”¨' || fieldName === 'å½“å‰æŠ•å…¥' || fieldName === 'æœ€ç»ˆèŠ±è´¹') {
                // å¤„ç†æ•°å€¼å­—æ®µï¼šå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²æˆ–æ— æ•ˆå€¼ï¼Œè®¾ä¸º0
                const numValue = newValue === '' || newValue === null || newValue === undefined 
                    ? 0 
                    : (isNaN(parseFloat(newValue)) ? 0 : parseFloat(newValue));
                updateData[fieldName] = numValue;
            } else {
                updateData[fieldName] = newValue;
            }
            
            // é‡æ–°è®¡ç®—å·®ä»·ï¼ˆä½¿ç”¨æ›´æ–°åçš„å€¼ï¼‰
            const valBudget = parseFloat(updateData['é¢„ç®—è´¹ç”¨']) || 0;
            const valFinal = parseFloat(updateData['æœ€ç»ˆèŠ±è´¹']) || 0;
            updateData['å·®ä»·'] = Math.round(valBudget - valFinal);
            
            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item: updateData })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('ä¿å­˜æˆåŠŸ', 'success');
                    // å…³é—­å•å­—æ®µç¼–è¾‘å¼¹çª—
                    document.getElementById('fieldEditModal').classList.remove('active');
                    document.getElementById('fieldEditForm').reset();
                    // ä»sessionStorageè·å–ä¿å­˜çš„itemId
                    const savedItemId = sessionStorage.getItem('currentEditingItemId');
                    if (savedItemId) {
                        const itemId = parseInt(savedItemId);
                        // é‡æ–°åŠ è½½æ•°æ®ï¼Œç­‰å¾…å®Œæˆåå†æ˜¾ç¤ºè¯¦æƒ…
                        await loadData(false);  // ä¸ä¿ç•™é¡µé¢çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®å®Œå…¨åˆ·æ–°
                        // ç­‰å¾…DOMæ¸²æŸ“å®Œæˆåå†æ˜¾ç¤ºè¯¦æƒ…
                        setTimeout(() => {
                            showItemDetail(itemId);
                        }, 100);
                    } else {
                        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„IDï¼Œåªé‡æ–°åŠ è½½æ•°æ®
                        await loadData(false);
                    }
                } else {
                    console.error('ä¿å­˜å¤±è´¥:', result);
                    showMessage('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜è¯·æ±‚å¤±è´¥:', error);
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä»è¯¦æƒ…å¼¹çª—åˆ é™¤
        async function deleteFromDetail() {
            if (currentDetailItemId === null) return;

            const item = items.find(i => i.id === currentDetailItemId);
            const itemName = item ? item['é¡¹ç›®'] : 'è¯¥é¡¹ç›®';

            // ç¬¬ä¸€æ¬¡ç¡®è®¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${itemName}"å—ï¼Ÿ`)) {
                return;
            }

            // ç¬¬äºŒæ¬¡ç¡®è®¤
            if (!confirm(`è¯·å†æ¬¡ç¡®è®¤ï¼šç¡®å®šè¦åˆ é™¤"${itemName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: [currentDetailItemId] })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeDetailModal();
                    loadData();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æäº¤è¡¨å•
        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const category = formData.get('category');
            
            // è‡ªåŠ¨è®¡ç®—å·®ä»·
            const valBudget = parseFloat(formData.get('é¢„ç®—è´¹ç”¨')) || 0;
            const valFinal = parseFloat(formData.get('æœ€ç»ˆèŠ±è´¹')) || 0;
            const diff = valBudget - valFinal;
            
            const item = {
                'é¡¹ç›®': formData.get('é¡¹ç›®'),
                'å•ä½': formData.get('å•ä½'),
                'é¢„ç®—æ•°é‡': formData.get('é¢„ç®—æ•°é‡'),
                'é¢„ç®—è´¹ç”¨': formData.get('é¢„ç®—è´¹ç”¨'),
                'å½“å‰æŠ•å…¥': formData.get('å½“å‰æŠ•å…¥'),
                'æœ€ç»ˆèŠ±è´¹': formData.get('æœ€ç»ˆèŠ±è´¹'),
                'å·®ä»·': Math.round(diff),
                'å¤‡æ³¨': formData.get('å¤‡æ³¨')
            };

            try {
                if (editingItemId !== null) {
                    // æ›´æ–°
                    item.id = editingItemId;
                    const response = await fetch('/api/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage(result.message, 'success');
                        closeModal();
                        if (window.innerWidth <= 768) {
                            document.getElementById('itemModal').style.display = 'none';
                        }
                        loadData();
                    } else {
                        showMessage('æ“ä½œå¤±è´¥: ' + result.error, 'error');
                    }
                } else {
                    // æ·»åŠ 
                    const response = await fetch('/api/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item, category })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showMessage(result.message, 'success');
                        closeModal();
                        if (window.innerWidth <= 768) {
                            document.getElementById('itemModal').style.display = 'none';
                        }
                        loadData();
                    } else {
                        showMessage('æ“ä½œå¤±è´¥: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤é€‰ä¸­é¡¹
        async function deleteSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const itemIds = Array.from(checkboxes).map(cb => 
                parseInt(cb.closest('tr').dataset.itemId)
            );

            if (itemIds.length === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${itemIds.length} é¡¹å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: itemIds })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadData();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºæ–‡ä»¶
        async function exportFile() {
            try {
                const response = await fetch('/api/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `çº¢çºå°å¤å¼è£…ä¿®é¢„ç®—è¡¨_å¯¼å‡º_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showMessage('å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    showMessage('å¯¼å‡ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºPDF
        async function exportPDF() {
            console.log('å¼€å§‹å¯¼å‡ºPDF...');
            try {
                showMessage('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...', 'success');
                
                console.log('å‘é€è¯·æ±‚åˆ° /api/export-pdf');
                const response = await fetch('/api/export-pdf');
                console.log('æ”¶åˆ°å“åº”:', response.status, response.statusText);
                
                if (response.ok) {
                    console.log('å“åº”æˆåŠŸï¼Œå¼€å§‹å¤„ç†blob...');
                    const blob = await response.blob();
                    console.log('Blobå¤§å°:', blob.size, 'å­—èŠ‚');
                    
                    // æ£€æŸ¥blobå¤§å°ï¼Œç¡®ä¿ä¸æ˜¯é”™è¯¯å“åº”
                    if (blob.size === 0) {
                        showMessage('PDFå¯¼å‡ºå¤±è´¥: ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©º', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥Content-Type
                    const contentType = response.headers.get('content-type');
                    console.log('Content-Type:', contentType);
                    
                    if (contentType && !contentType.includes('pdf')) {
                        // å¯èƒ½æ˜¯é”™è¯¯å“åº”ï¼Œå°è¯•è§£æJSON
                        const text = await blob.text();
                        try {
                            const result = JSON.parse(text);
                            showMessage('PDFå¯¼å‡ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                            return;
                        } catch (e) {
                            // ä¸æ˜¯JSONï¼Œç»§ç»­å¤„ç†
                            console.log('ä¸æ˜¯JSONå“åº”ï¼Œç»§ç»­å¤„ç†ä¸ºPDF');
                        }
                    }
                    
                    console.log('åˆ›å»ºä¸‹è½½é“¾æ¥...');
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `çº¢çºå°å¤å¼è£…ä¿®é¢„ç®—è¡¨_å¯¼å‡º_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showMessage('PDFå¯¼å‡ºæˆåŠŸ', 'success');
                    console.log('PDFå¯¼å‡ºå®Œæˆ');
                } else {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                    let errorMsg = 'PDFå¯¼å‡ºå¤±è´¥';
                    try {
                        const result = await response.json();
                        errorMsg = result.error || errorMsg;
                        if (result.traceback) {
                            console.error('è¯¦ç»†é”™è¯¯:', result.traceback);
                        }
                    } catch (e) {
                        errorMsg = `HTTPé”™è¯¯: ${response.status} ${response.statusText}`;
                    }
                    showMessage(errorMsg, 'error');
                    console.error('PDFå¯¼å‡ºå¤±è´¥:', errorMsg);
                }
            } catch (error) {
                showMessage('PDFå¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                console.error('PDFå¯¼å‡ºé”™è¯¯:', error);
            }
        }

        // åˆ†ç±»å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleCategorySelectAll(category, checked) {
            const rows = document.querySelectorAll(`tr[data-category="${category}"]`);
            rows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) checkbox.checked = checked;
            });
            updateDeleteButton();
        }

        // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
        function updateDeleteButton() {
            const checked = document.querySelectorAll('.row-checkbox:checked').length;
            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = checked === 0;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const msgEl = document.getElementById('statusMessage');
            msgEl.textContent = message;
            msgEl.className = `status-message ${type}`;
            setTimeout(() => {
                msgEl.className = 'status-message';
            }, 3000);
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(value) {
            if (!value || value === '' || value === 'nan') return '0';
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            // æ˜¾ç¤ºä¸ºæ•´æ•°ï¼Œä¸å¸¦å°æ•°ç‚¹
            return Math.round(num).toLocaleString('zh-CN');
        }

        // AIè§£æé¢„è§ˆ
        async function parseAndPreview() {
            const text = document.getElementById('aiInput').value.trim();
            if (!text) {
                showMessage('è¯·è¾“å…¥è¦è§£æçš„æ–‡æœ¬', 'error');
                return;
            }

            const preview = document.getElementById('aiPreview');
            preview.style.display = 'block';
            preview.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">è§£æä¸­...</div>';

            try {
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const result = await response.json();
                
                if (result.success && result.item) {
                    const item = result.item;
                    let html = '<div style="margin-bottom: 10px; font-weight: 600; color: #495057;">è§£æç»“æœï¼š</div>';
                    // å…¼å®¹æ–°æ—§å­—æ®µå
                    const val1st = parseFloat(item['1sté¢„ç®—è´¹ç”¨'] || 0) || 0;
                    const val2nd = parseFloat(item['2ndé¢„ç®—è´¹ç”¨'] || 0) || 0;
                    const valBudget = parseFloat(item['é¢„ç®—è´¹ç”¨'] || 0) || (val2nd > 0 ? val2nd : val1st);
                    const valCurrent = parseFloat(item['å½“å‰æŠ•å…¥'] || 0) || parseFloat(item['æœ€ç»ˆå®é™…èŠ±è´¹'] || 0) || 0;
                    const valFinal = parseFloat(item['æœ€ç»ˆèŠ±è´¹'] || 0) || 0;
                    
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">åˆ†ç±»ï¼š</span><span class="ai-preview-value">' + escapeHtml(item.category || 'æœªåˆ†ç±»') + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">é¡¹ç›®åç§°ï¼š</span><span class="ai-preview-value">' + escapeHtml(item['é¡¹ç›®'] || '') + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">å•ä½ï¼š</span><span class="ai-preview-value">' + escapeHtml(item['å•ä½'] || '-') + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">æ•°é‡ï¼š</span><span class="ai-preview-value">' + escapeHtml(item['é¢„ç®—æ•°é‡'] || '-') + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">é¢„ç®—è´¹ç”¨ï¼š</span><span class="ai-preview-value">' + formatNumber(valBudget) + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">å½“å‰æŠ•å…¥ï¼š</span><span class="ai-preview-value">' + formatNumber(valCurrent) + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">æœ€ç»ˆèŠ±è´¹ï¼š</span><span class="ai-preview-value">' + formatNumber(valFinal) + '</span></div>';
                    html += '<div class="ai-preview-item"><span class="ai-preview-label">å¤‡æ³¨ï¼š</span><span class="ai-preview-value">' + escapeHtml(item['å¤‡æ³¨'] || '-') + '</span></div>';
                    html += '<div class="ai-preview-actions">';
                    html += '<button class="btn btn-secondary btn-small" onclick="closePreview()">å–æ¶ˆ</button>';
                    html += '<button class="btn btn-success btn-small" onclick="confirmAddFromPreview()">ç¡®è®¤æ·»åŠ </button>';
                    html += '</div>';
                    preview.innerHTML = html;
                    preview.dataset.parsedItem = JSON.stringify(result.item);
                } else {
                    preview.innerHTML = '<div style="color: #dc3545; padding: 20px;">è§£æå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                preview.innerHTML = '<div style="color: #dc3545; padding: 20px;">è§£æå¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ç›´æ¥è§£æå¹¶æ·»åŠ 
        async function parseAndAdd() {
            const text = document.getElementById('aiInput').value.trim();
            if (!text) {
                showMessage('è¯·è¾“å…¥è¦è§£æçš„æ–‡æœ¬', 'error');
                return;
            }

            try {
                const response = await fetch('/api/parse-and-add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const result = await response.json();
                
                if (result.success) {
                    let message = result.message || 'æ·»åŠ æˆåŠŸ';
                    if (result.count && result.count > 1) {
                        message = `æˆåŠŸæ·»åŠ  ${result.count} é¡¹`;
                        if (result.errors && result.errors.length > 0) {
                            message += `ï¼Œå¤±è´¥ ${result.errors.length} é¡¹`;
                        }
                    }
                    showMessage(message, result.count === result.total ? 'success' : 'error');
                    document.getElementById('aiInput').value = '';
                    document.getElementById('aiPreview').style.display = 'none';
                    loadData();
                } else {
                    let errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';
                    if (result.errors && result.errors.length > 0) {
                        errorMsg += ': ' + result.errors.join('; ');
                    }
                    showMessage('æ·»åŠ å¤±è´¥: ' + errorMsg, 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¡®è®¤ä»é¢„è§ˆæ·»åŠ ï¼ˆå•ä¸ªé¡¹ç›®ï¼‰
        async function confirmAddFromPreview() {
            const preview = document.getElementById('aiPreview');
            if (!preview.dataset.parsedItem) {
                showMessage('æ²¡æœ‰å¯æ·»åŠ çš„æ•°æ®', 'error');
                return;
            }
            
            const itemData = JSON.parse(preview.dataset.parsedItem);
            const category = itemData.category || '';
            
            // ä»itemDataä¸­ç§»é™¤categoryï¼Œå› ä¸ºAPIä¼šå•ç‹¬å¤„ç†
            const item = { ...itemData };
            delete item.category;
            
            try {
                const response = await fetch('/api/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item, category })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('aiInput').value = '';
                    preview.style.display = 'none';
                    loadData();
                } else {
                    showMessage('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰¹é‡ç¡®è®¤æ·»åŠ 
        async function confirmBatchAddFromPreview() {
            const preview = document.getElementById('aiPreview');
            if (!preview.dataset.parsedItems) {
                showMessage('æ²¡æœ‰å¯æ·»åŠ çš„æ•°æ®', 'error');
                return;
            }
            
            const items = JSON.parse(preview.dataset.parsedItems);
            if (!items || items.length === 0) {
                showMessage('æ²¡æœ‰å¯æ·»åŠ çš„æ•°æ®', 'error');
                return;
            }
            
            // æ‰¹é‡æ·»åŠ 
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (let i = 0; i < items.length; i++) {
                const itemData = items[i];
                const category = itemData.category || '';
                
                // ä»itemDataä¸­ç§»é™¤category
                const item = { ...itemData };
                delete item.category;
                
                try {
                    const response = await fetch('/api/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ item, category })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        errors.push(`é¡¹ç›®${i + 1}: ${result.error || 'æ·»åŠ å¤±è´¥'}`);
                    }
                } catch (error) {
                    errorCount++;
                    errors.push(`é¡¹ç›®${i + 1}: ${error.message}`);
                }
            }
            
            if (successCount > 0) {
                let message = `æˆåŠŸæ·»åŠ  ${successCount} é¡¹`;
                if (errorCount > 0) {
                    message += `ï¼Œå¤±è´¥ ${errorCount} é¡¹`;
                }
                showMessage(message, successCount === items.length ? 'success' : 'error');
                document.getElementById('aiInput').value = '';
                preview.style.display = 'none';
                loadData();
            } else {
                showMessage('æ‰€æœ‰é¡¹ç›®æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            document.getElementById('aiPreview').style.display = 'none';
        }

        // æ˜¾ç¤ºæ–°å¢åˆ†ç±»æ¨¡æ€æ¡†
        function showAddCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('categoryNameInput').value = '';
        }

        // å…³é—­åˆ†ç±»æ¨¡æ€æ¡†
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryForm').reset();
        }

        // æäº¤æ–°å¢åˆ†ç±»è¡¨å•
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = document.getElementById('categoryNameInput').value.trim();
            
            if (!categoryName) {
                showMessage('è¯·è¾“å…¥åˆ†ç±»åç§°', 'error');
                return;
            }

            try {
                const response = await fetch('/api/add-category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_name: categoryName })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeCategoryModal();
                    loadData();
                } else {
                    showMessage('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(categoryName, categoryId, event) {
            if (event) {
                event.stopPropagation();  // é˜»æ­¢è§¦å‘åˆ†ç±»å›¾è¡¨çš„ç‚¹å‡»äº‹ä»¶
            }
            
            // ç»Ÿè®¡è¯¥åˆ†ç±»ä¸‹çš„é¡¹ç›®æ•°é‡
            const categoryItems = items.filter(item => item.category === categoryName);
            const itemCount = categoryItems.length;
            
            let confirmMessage = `ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${categoryName}"å—ï¼Ÿ`;
            if (itemCount > 0) {
                confirmMessage += `\nè¯¥åˆ†ç±»ä¸‹æœ‰ ${itemCount} ä¸ªé¡¹ç›®ï¼Œåˆ é™¤åˆ†ç±»åè¿™äº›é¡¹ç›®å°†å˜ä¸º"æœªåˆ†ç±»"ã€‚`;
            }
            confirmMessage += '\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // ç¬¬äºŒæ¬¡ç¡®è®¤
            if (!confirm(`è¯·å†æ¬¡ç¡®è®¤ï¼šç¡®å®šè¦åˆ é™¤åˆ†ç±»"${categoryName}"å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_id: categoryId })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadData();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå¤‡ä»½/æ¢å¤æ¨¡æ€æ¡†
        function showBackupModal() {
            document.getElementById('backupModal').classList.add('active');
            loadBackupList();
        }

        // å…³é—­å¤‡ä»½/æ¢å¤æ¨¡æ€æ¡†
        function closeBackupModal() {
            document.getElementById('backupModal').classList.remove('active');
            document.getElementById('backupDescription').value = '';
        }

        // åŠ è½½å¤‡ä»½åˆ—è¡¨
        async function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch('/api/backups');
                const result = await response.json();
                
                if (result.success) {
                    const backups = result.backups || [];
                    
                    if (backups.length === 0) {
                        backupList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— å¤‡ä»½</div>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    backups.forEach(backup => {
                        const date = new Date(backup.created_at);
                        const dateStr = date.toLocaleString('zh-CN');
                        const sizeKB = (backup.size / 1024).toFixed(2);
                        const description = backup.description ? ` - ${backup.description}` : '';
                        
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">`;
                        html += `<div style="flex: 1;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(backup.filename)}${escapeHtml(description)}</div>`;
                        html += `<div style="font-size: 12px; color: #6c757d;">${dateStr} Â· ${sizeKB} KB</div>`;
                        html += `</div>`;
                        html += `<div style="display: flex; gap: 8px;">`;
                        html += `<button class="btn btn-primary" onclick="restoreBackup('${escapeHtml(backup.filename)}')" style="padding: 6px 12px; font-size: 12px;">ğŸ”„ æ¢å¤</button>`;
                        html += `<button class="btn btn-danger" onclick="deleteBackupFile('${escapeHtml(backup.filename)}')" style="padding: 6px 12px; font-size: 12px;">ğŸ—‘ï¸ åˆ é™¤</button>`;
                        html += `</div>`;
                        html += `</div>`;
                    });
                    html += '</div>';
                    backupList.innerHTML = html;
                } else {
                    backupList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                backupList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºå¤‡ä»½
        async function createBackup() {
            const description = document.getElementById('backupDescription').value.trim();
            
            try {
                const response = await fetch('/api/backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    document.getElementById('backupDescription').value = '';
                    loadBackupList();
                } else {
                    showMessage('å¤‡ä»½å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¢å¤å¤‡ä»½
        async function restoreBackup(backupFilename) {
            if (!confirm(`ç¡®å®šè¦ä»å¤‡ä»½ "${backupFilename}" æ¢å¤æ•°æ®åº“å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼\n\nç³»ç»Ÿä¼šåœ¨æ¢å¤å‰è‡ªåŠ¨åˆ›å»ºå½“å‰æ•°æ®åº“çš„å¤‡ä»½ã€‚`)) {
                return;
            }
            
            if (!confirm(`è¯·å†æ¬¡ç¡®è®¤ï¼šç¡®å®šè¦æ¢å¤æ•°æ®åº“å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup_filename: backupFilename })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeBackupModal();
                    // å»¶è¿Ÿä¸€ä¸‹å†åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ•°æ®åº“å·²æ¢å¤
                    setTimeout(() => {
                        loadData();
                    }, 500);
                } else {
                    showMessage('æ¢å¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤å¤‡ä»½
        async function deleteBackupFile(backupFilename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½ "${backupFilename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup_filename: backupFilename })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadBackupList();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ”¯æŒå›è½¦é”®å¿«é€Ÿæ·»åŠ ï¼ˆCtrl+Enterï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        parseAndAdd();
                    }
                });
            }
        });

        // æ’åºçŠ¶æ€å­˜å‚¨ï¼ˆæ¯ä¸ªåˆ†ç±»ç‹¬ç«‹ï¼‰
        const sortState = {};

        // è¡¨å¤´ç‚¹å‡»æ’åºåŠŸèƒ½
        function sortItems(category, field, headerElement) {
            // è·å–è¯¥åˆ†ç±»çš„æ‰€æœ‰é¡¹ç›®
            const categorySection = document.querySelector(`.category-section[data-category="${category}"]`);
            if (!categorySection) return;

            const tbody = categorySection.querySelector('tbody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr[data-item-id]'));
            if (rows.length === 0) return;

            // è·å–å½“å‰æ’åºçŠ¶æ€
            const sortKey = `${category}_${field}`;
            const currentSort = sortState[sortKey] || 'asc';
            
            // åˆ‡æ¢æ’åºæ–¹å‘ï¼šasc <-> desc
            const newSort = currentSort === 'asc' ? 'desc' : 'asc';
            sortState[sortKey] = newSort;

            // æ¸…é™¤æ‰€æœ‰æ’åºæŒ‡ç¤ºå™¨
            categorySection.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '';
            });

            // æ˜¾ç¤ºæ’åºæŒ‡ç¤ºå™¨
            const indicator = headerElement.querySelector('.sort-indicator');
            if (indicator) {
                indicator.textContent = newSort === 'asc' ? ' â†‘' : ' â†“';
            }

            // æå–æ•°æ®å¹¶æ’åº
            const rowData = rows.map(row => {
                const itemId = parseInt(row.dataset.itemId);
                const cells = row.querySelectorAll('td');
                
                let value;
                if (field === 'é¡¹ç›®') {
                    value = cells[2]?.textContent?.trim() || '';
                } else if (field === 'é¢„ç®—è´¹ç”¨') {
                    value = parseFloat(cells[3]?.textContent?.replace(/,/g, '') || 0);
                } else if (field === 'å½“å‰æŠ•å…¥') {
                    value = parseFloat(cells[4]?.textContent?.replace(/,/g, '') || 0);
                } else if (field === 'æœ€ç»ˆèŠ±è´¹') {
                    value = parseFloat(cells[5]?.textContent?.replace(/,/g, '') || 0);
                } else if (field === 'å·®ä»·') {
                    value = parseFloat(cells[6]?.textContent?.replace(/,/g, '') || 0);
                } else {
                    value = '';
                }

                return { row, value, itemId };
            });

            // æ’åº
            rowData.sort((a, b) => {
                if (newSort === 'asc') {
                    if (field === 'é¡¹ç›®') {
                        return a.value.localeCompare(b.value, 'zh-CN');
                    } else {
                        return a.value - b.value;
                    }
                } else {
                    if (field === 'é¡¹ç›®') {
                        return b.value.localeCompare(a.value, 'zh-CN');
                    } else {
                        return b.value - a.value;
                    }
                }
            });

            // é‡æ–°æ’å…¥æ’åºåçš„è¡Œï¼Œå¹¶æ›´æ–°åºå·
            rowData.forEach(({ row }, index) => {
                tbody.appendChild(row);
                // æ›´æ–°åºå·ï¼ˆç¬¬äºŒåˆ—ï¼Œç´¢å¼•ä¸º1ï¼‰
                const cells = row.querySelectorAll('td');
                if (cells[1]) {
                    cells[1].textContent = index + 1;
                }
            });
        }

        // æŠ˜å /å±•å¼€åˆ†ç±»
        function toggleCategory(category, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const categorySection = document.querySelector(`.category-section[data-category="${category}"]`);
            if (!categorySection) return;

            const content = categorySection.querySelector('.category-content');
            const toggle = categorySection.querySelector('.category-toggle');
            
            if (!content || !toggle) return;

            const isCollapsed = content.classList.contains('collapsed');
            
            if (isCollapsed) {
                // å±•å¼€
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = 'â–¼';
            } else {
                // æŠ˜å 
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = 'â–¶';
            }
            
            // ä¿å­˜æŠ˜å çŠ¶æ€
            savePageState();
        }


        // æ˜¾ç¤ºå¯¼å…¥æ¨¡æ€æ¡†
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importForm').reset();
            document.getElementById('importValidation').style.display = 'none';
            document.getElementById('importValidation').innerHTML = '';
        }

        // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importForm').reset();
            document.getElementById('importValidation').style.display = 'none';
            document.getElementById('importValidation').innerHTML = '';
        }

        // éªŒè¯å¯¼å…¥æ–‡ä»¶æ ¼å¼
        async function validateImportFile() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const validationDiv = document.getElementById('importValidation');
            validationDiv.style.display = 'block';
            validationDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">éªŒè¯ä¸­...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/validate', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                let html = '';
                if (result.success && result.valid) {
                    html += '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 6px; border: 1px solid #c3e6cb;">';
                    html += '<strong>âœ“ æ ¼å¼éªŒè¯é€šè¿‡</strong><br>';
                    html += `åˆ†ç±»æ•°é‡: ${result.category_count || 0}<br>`;
                    html += `æ•°æ®è¡Œ: ${result.has_data ? 'æœ‰' : 'æ— '}<br>`;
                    if (result.warnings && result.warnings.length > 0) {
                        html += '<div style="margin-top: 10px; color: #856404;">';
                        html += '<strong>æç¤ºï¼š</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                        result.warnings.forEach(w => html += `<li>${escapeHtml(w)}</li>`);
                        html += '</ul></div>';
                    }
                    html += '</div>';
                } else {
                    html += '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; border: 1px solid #f5c6cb;">';
                    html += '<strong>âœ— æ ¼å¼éªŒè¯å¤±è´¥</strong><br>';
                    if (result.errors && result.errors.length > 0) {
                        html += '<ul style="margin: 10px 0; padding-left: 20px;">';
                        result.errors.forEach(e => html += `<li>${escapeHtml(e)}</li>`);
                        html += '</ul>';
                    }
                    if (result.warnings && result.warnings.length > 0) {
                        html += '<div style="margin-top: 10px; color: #856404;">';
                        html += '<strong>æç¤ºï¼š</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                        result.warnings.forEach(w => html += `<li>${escapeHtml(w)}</li>`);
                        html += '</ul></div>';
                    }
                    html += '</div>';
                }
                validationDiv.innerHTML = html;
            } catch (error) {
                validationDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px;">éªŒè¯å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æäº¤å¯¼å…¥è¡¨å•
        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            if (!confirm('âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿå»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½ã€‚')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    let successMsg = `å¯¼å…¥æˆåŠŸï¼å·²å¯¼å…¥ ${result.category_count} ä¸ªåˆ†ç±»ï¼Œ${result.item_count} ä¸ªé¡¹ç›®ã€‚`;
                    if (result.warnings && result.warnings.length > 0) {
                        successMsg += '\nè­¦å‘Šï¼š' + result.warnings.join('; ');
                    }
                    showMessage(successMsg, 'success');
                    closeImportModal();
                    loadData();
                } else {
                    let errorMsg = 'å¯¼å…¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯');
                    if (result.errors && result.errors.length > 0) {
                        errorMsg += '\n' + result.errors.join('\n');
                    }
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼ˆä»…åœ¨å·²éªŒè¯æ—¶ï¼‰
        // å¯†ç éªŒè¯é€šè¿‡åä¼šè‡ªåŠ¨è°ƒç”¨loadData()
    </script>
</body>
</html>

