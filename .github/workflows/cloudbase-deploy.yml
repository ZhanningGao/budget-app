name: Deploy to CloudBase CloudRun

on:
  push:
    branches:
      - dev_tcb  # æ¨é€åˆ° dev_tcb åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TCB_ENV_ID: ${{ secrets.TCB_ENV_ID }}  # è…¾è®¯äº‘ç¯å¢ƒID
  TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}  # è…¾è®¯äº‘ SecretId
  TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}  # è…¾è®¯äº‘ SecretKey

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install CloudBase CLI
        run: npm install -g @cloudbase/cli

      - name: Login to CloudBase
        run: |
          tcb login --apiKeyId ${{ secrets.TCB_SECRET_ID }} --apiKey ${{ secrets.TCB_SECRET_KEY }}

      - name: Verify environment
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          echo "Environment ID: ${{ secrets.TCB_ENV_ID }}"
          echo "Service Name: ${{ secrets.TCB_SERVICE_NAME || 'budget-manager' }}"
          tcb env:list || echo "âš ï¸ æ— æ³•åˆ—å‡ºç¯å¢ƒï¼Œä½†ç»§ç»­éƒ¨ç½²..."

      - name: Deploy to CloudRun
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          SERVICE_NAME="${{ secrets.TCB_SERVICE_NAME || 'budget-manager' }}"
          # ç¡®ä¿æœåŠ¡åç§°ç¬¦åˆè§„èŒƒï¼ˆåªåŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ï¼‰
          SERVICE_NAME=$(echo "$SERVICE_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
          # ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„è¿å­—ç¬¦
          SERVICE_NAME=$(echo "$SERVICE_NAME" | sed 's/^-\+//;s/-\+$//')
          echo "ğŸ“¦ ä½¿ç”¨æœåŠ¡åç§°: $SERVICE_NAME"
          echo "ğŸ“‹ ç¯å¢ƒID: ${{ secrets.TCB_ENV_ID }}"
          echo "y" | tcb cloudrun deploy \
            --envId ${{ secrets.TCB_ENV_ID }} \
            --serviceName "$SERVICE_NAME"
        continue-on-error: false

